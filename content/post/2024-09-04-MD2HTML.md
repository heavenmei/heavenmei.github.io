---
title: React+Contentlayeræ„å»ºé™æ€åšå®¢ç½‘ç«™
subtitle: 
layout: post
date: 2024-09-04
author: heavenmei
categories:
  - Post
description: 
tags:
  - Web
url: 
image:
---
> [Contentlayer](https://www.contentlayer.dev/)Â æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„é™æ€ç½‘ç«™ç”Ÿæˆå™¨ï¼Œä¸“ä¸ºæ„å»ºå’Œç®¡ç†é™æ€é¡µé¢ã€ç½‘ç«™å’Œåšå®¢è€Œè®¾è®¡ã€‚å®ƒæä¾›äº†ä¸€ç§ç®€å•è€Œçµæ´»çš„æ–¹å¼æ¥åˆ›å»ºå’Œç»„ç»‡å†…å®¹ï¼Œå¯ä»¥å°†`Markdown`æ–‡ä»¶è½¬æ¢ä¸ºé™æ€`HTML`é¡µé¢ã€‚


## ä½¿ç”¨
åŸºäºNextï¼Œå®‰è£…
```zsh
yarn add contentlayer next-contentlayer -S
```


åˆ›å»º **contentlayer.config.ts**
```ts

```


## åŸç†

markdown å¤„ç†åœ¨[contentlayer](https://www.contentlayer.dev/)ä¸­æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚
[contentlayer](https://www.contentlayer.dev/)ä½¿ç”¨[remark](https://github.com/remarkjs/remark)å°† markdown è§£æä¸º[mdast](https://github.com/syntax-tree/mdast)ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨`remark plugins`æ¥ä¿®æ”¹`mdast`ã€‚ç„¶å`rehype`å‘æŒ¥ä½œç”¨å¹¶å°† è½¬æ¢`mdast`ä¸º[hast](https://github.com/syntax-tree/hast)ã€‚Â `rehype plugins`ç°åœ¨å¯ä»¥ä¿®æ”¹`hast`ã€‚æœ€å`hast`å°† è½¬æ¢ä¸º[react](https://reactjs.org/)ç»„ä»¶ã€‚

![|500](./assets/20241109134809.png)



## Markdownä¼˜åŒ–æ’ä»¶

- **`remark-gfm`**ï¼šç”¨äºæ‰©å±•Â **`remark`**Â çš„åŠŸèƒ½ï¼Œæ”¯æŒ GitHub Flavored Markdown (GFM) çš„è¯­æ³•ã€‚å®ƒå¯ä»¥å¤„ç† GFM çš„ç‰¹æ®Šè¯­æ³•ï¼Œå¦‚ä»»åŠ¡åˆ—è¡¨ã€è¡¨æ ¼ç­‰ã€‚
- **`remark-math`**ï¼šç”¨äºåœ¨ Markdown ä¸­æ”¯æŒæ•°å­¦å…¬å¼çš„æ¸²æŸ“ã€‚å®ƒå¯ä»¥è§£æ LaTeX æˆ– MathML æ ¼å¼çš„æ•°å­¦å…¬å¼ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º HTML æˆ–å…¶ä»–æ ¼å¼è¿›è¡Œæ˜¾ç¤ºã€‚
- **`remark-rehype`**ï¼šç”¨äºå°†Â **`remark`**Â çš„ AST è½¬æ¢ä¸ºÂ **`rehype`**Â çš„ ASTã€‚å®ƒå¯ä»¥åœ¨Â **`remark`**Â å’ŒÂ **`rehype`**Â ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œä»¥ä¾¿ä½¿ç”¨Â **`rehype`**Â çš„æ’ä»¶å¯¹ Markdown è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚



- **`rehype-pretty-code`**ï¼šç”¨äºç¾åŒ–ä»£ç å—çš„æ ·å¼å’Œæ˜¾ç¤ºã€‚å®ƒå¯ä»¥å¯¹ä»£ç è¿›è¡Œè¯­æ³•é«˜äº®ã€æ·»åŠ è¡Œå·ç­‰æ“ä½œï¼Œä»¥æå‡ä»£ç çš„å¯è¯»æ€§ã€‚
- **`rehype-raw`**ï¼šç”¨äºä¿ç•™ HTML æ ‡ç­¾çš„åŸå§‹å†…å®¹ï¼Œè€Œä¸è¿›è¡Œä»»ä½•è½¬æ¢ã€‚å®ƒå¯ä»¥ç”¨äºå¤„ç†åŒ…å«è‡ªå®šä¹‰ HTML æ ‡ç­¾æˆ–ç‰¹æ®Šéœ€æ±‚çš„å†…å®¹ã€‚
- **`rehype-stringify`**ï¼šç”¨äºå°†Â **`rehype`**Â çš„ ASTï¼ˆAbstract Syntax Treeï¼‰è½¬æ¢å› HTML å­—ç¬¦ä¸²ã€‚å®ƒå¯ä»¥å°†ç»è¿‡å¤„ç†çš„ AST è½¬æ¢ä¸ºæœ‰æ•ˆçš„ HTML ä»£ç ã€‚
- [`rehype-slug`](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frehypejs%2Frehype-slug "https://github.com/rehypejs/rehype-slug"): h1-h6 æ ‡ç­¾æ·»åŠ  idï¼Œç”¨äºä¸ºæ ‡é¢˜ç”Ÿæˆå”¯ä¸€çš„ slugï¼ˆURL-friendly stringï¼Œå¸¸ç”¨äºé”šé“¾æ¥ï¼‰ã€‚å®ƒå¯ä»¥å°†æ ‡é¢˜æ–‡æœ¬è½¬æ¢ä¸ºå°å†™ã€ç§»é™¤ç‰¹æ®Šå­—ç¬¦ç­‰ï¼Œä»¥ç”Ÿæˆæ˜“äºå¤„ç†å’Œè¯†åˆ«çš„ slugã€‚
- [`rehype-autolink-headings`](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frehypejs%2Frehype-autolink-headings "https://github.com/rehypejs/rehype-autolink-headings"): æ·»åŠ é”šç‚¹


## è‡ªå®šä¹‰rehype æ’ä»¶å¤„ç†æœ¬åœ°å›¾ç‰‡
> referenceï¼š[Contentlayer with next/image](https://sdorra.dev/posts/2022-12-11-contentlayer-next-image)

**æ€è·¯**
1. æœç´¢Â `hast`Â æ ‘ï¼Œå¯¹äºæ¯ä¸ªå¸¦`img`Â çš„å…ƒç´ ï¼Œæ‰¾åˆ°å›¾ç‰‡çœŸå®è·¯å¾„ã€‚
2. åˆ©ç”¨`sharp`è¯»å–å›¾åƒå®½é«˜ï¼Œåˆ›å»ºå ä½ç¬¦ã€‚(è‹¥ä¸ä½¿ç”¨next/Imageå¯ä»¥ç•¥è¿‡)
3. å°†å›¾ç‰‡å¤åˆ¶åˆ°`public`æ–‡ä»¶å¤¹ï¼Œä¿æŒè·¯å¾„ä¸€è‡´ã€‚
4. æ›´æ–°`img`æ ‡ç­¾å±æ€§
5. é…ç½®æ’ä»¶

**æ³¨æ„âš ï¸**
`Rehype`Â æ’ä»¶ä¸èƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä½†å›¾åƒå¤„ç†æ˜¯å¼‚æ­¥çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†Â `processImage`Â å‡½æ•°çš„æ¯ä¸ªç»“æœçš„Â `Promise`Â å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå¦‚æœæ‰€æœ‰Â `Promise`Â éƒ½å·²è§£å†³å¹¶ä¸”å·¥ä½œå·²å®Œæˆï¼Œåˆ™è°ƒç”¨Â `done`Â å‡½æ•°


**Implementation**
ç¼–å†™æ–‡ä»¶`static-images.ts`

```js
import fs from "fs/promises";
import { Element, Root } from "hast";
import crypto from "node:crypto";
import path from "node:path";
import sharp from "sharp";
import { Plugin } from "unified";
import { visit } from "unist-util-visit";

type Options = {
  sourceRoot: string;
  publicDir: string;
  resourcePath: string;
};

const fileChecksum = async (file: string) => {
  try {
    return checksum(await fs.readFile(file));
  } catch (_) {
    return "";
  }
};

const checksum = (content: Buffer) => {
  return crypto.createHash("sha256").update(content).digest("hex");
};

const copy = async (source: string, sha256sum: string, target: string) => {
  if (sha256sum !== (await fileChecksum(target))) {
    const targetDir = path.dirname(target);

    await fs.mkdir(targetDir, { recursive: true });
    await fs.copyFile(source, target);
  }
};

const createPlaceholder = async (image: sharp.Sharp) => {
  const { width, height } = await image.metadata();
  if (!width || !height) {
    throw new Error("fetched image without width and height");
  }

  const imgAspectRatio = width / height;

  const placeholderImgWidth = 8;
  const placeholderImgHeight = Math.round(placeholderImgWidth / imgAspectRatio);

  return image
    .resize(placeholderImgWidth, placeholderImgHeight)
    .png({
      quality: 75,
    })
    .toBuffer()
    .then((buffer) => `data:image/png;base64,${buffer.toString("base64")}`);
};

const metadata = async (
  resourcePath: string,
  source: string,
  pathname: string
) => {
  const content = await fs.readFile(source);
  const image = await sharp(content);

  const { width, height } = await image.metadata();

  if (!width || !height) {
    return null;
  }

  const src = resourcePath + "/" + pathname;

  const sha256 = checksum(content);

  const blurDataURL = await createPlaceholder(image);
  return {
    sha256,
    props: {
      width,
      height,
      src,
      blurDataURL,
    },
  };
};

const processImage = async (
  options: Options,
  file: any,
  node: Element
): Promise<void> => {
  const root = options.sourceRoot;
  const pathname = path.join(
    file.data.rawDocumentData.sourceFileDir,
    (node.properties?.src as string) || ""
  );
  const source = path.join(root, pathname);

  const meta = await metadata(options.resourcePath, source, pathname);
  if (!meta) {
    return;
  }

  const target = path.join(options.publicDir, pathname);
  await copy(source, meta.sha256, target);

  if (!node.properties) {
    node.properties = {};
  }
  node.properties = {
    ...node.properties,
    ...meta.props,
  };
};

export const staticCoverImage = async (
  sourceRoot: string,
  targetRoot: string,
  resourcePath: string,
  directory: string,
  image: string
) => {
  if (image.includes("://")) {
    return image;
  }

  const source = path.join(sourceRoot, directory, image);
  const content = await fs.readFile(source);
  const sha256sum = checksum(content);
  const target = path.join(targetRoot, directory, image);

  await copy(source, sha256sum, target);

  return `${resourcePath}/${directory}/${image}`;
};

const staticImages: Plugin<[Options], Root> =
  // @ts-ignore
  (options) => (tree, file, done) => {
    const tasks: Promise<void>[] = [];

    visit(tree, "element", (node) => {
      if (node.tagName === "img" && !node.properties.src.includes("://")) {
        tasks.push(processImage(options, file, node));
      }
    });

    Promise.all(tasks).then(() => done());
  };

export default staticImages;

```



`contentlayer.config.js` ä¸­å¼•ç”¨è¯¥æ’ä»¶
```js
import mdxImages from "./lib/static-images";
...
export default makeSource({
  ...
  mdx: {
    remarkPlugins: [
     ...
    ],
    rehypePlugins: [
      [
        mdxImages,
        {
          publicDir: path.join(process.cwd(), "public"),
          sourceRoot: path.join(process.cwd(), "content"),
          resourcePath: "",
        },
      ],
      ...
    ],
  },
});

```


`Markdown.tsx` åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å¹¶ä¼ é€’å‚æ•°
```js
import { useMDXComponent } from "next-contentlayer/hooks";
import type { MDXComponents } from "mdx/types";

const components: MDXComponents = {
  ...
  img: ({ className, ...props }: any) =>
    props.width ? (
      //Imageå¿…é¡»æŒ‡å®šwidth/height,è‹¥æ²¡æœ‰è¯¥å€¼åˆ™ç”¨imgæ ‡ç­¾è‡ªé€‚åº”imageæœ¬èº«å¤§å°
      <Image className={cn("rounded-md border m-auto", className)} {...props} />
    ) : (
      <img className={cn("rounded-md border", className)} {...props} />
    ),
};

export function Mdx({ code }: { code: string }) {
  const Component = useMDXComponent(code);

  return (
    <div className="mdx">
      <Component components={components} />
    </div>
  );
}

```




## è‡ªå®šä¹‰rehype æ’ä»¶-ä»£ç å—å¤åˆ¶
**æ€è·¯**
1. è·å–`pre`çš„å†…å®¹æ”¾åœ¨è¯¥èŠ‚ç‚¹rawå‚æ•°ä¸­
2. ç”±äº`rehypePrettyCode`ä¼šæŠŠä»£ç æ ¼å¼åŒ–ï¼Œå°†`pre`çš„å±æ€§é‡ç½®åˆ°`figure`æ ‡ç­¾ä¸­ï¼Œå¹¶å¯¹ä»£ç æŒ‰è¡Œæ‹†åˆ†ã€‚å› æ­¤ï¼Œè¯¥å‡½æ•°å¾—åœ¨è¯¥æ’ä»¶ä¹‹å‰æ‰§è¡Œ
3. å°†åç½®å¤„ç†æ—¶ï¼Œå°†`figure`æ ‡ç­¾ä¸­rawå‚æ•°é‡æ–°å¤åˆ¶åˆ°`pre`æ ‡ç­¾ä¸Š
4. é…ç½®æ’ä»¶

`copy-code.js`
```js
import { visit } from "unist-util-visit";

// è·å–ä»£ç å—å†…å®¹
export const preProcess = () => (tree) => {
  visit(tree, (node) => {
    if (node?.type === "element" && node?.tagName === "pre") {
      const [codeEl] = node.children;

      if (codeEl.tagName !== "code") return;
      node.properties.raw = codeEl.children?.[0].value;
      // console.log("ğŸš¨ preProcess ~", node);
    }
  });
};

// ä»£ç å—å†…å®¹æ”¾è¿›pre.raw
export const postProcess = () => (tree) => {
  visit(tree, "element", (node) => {
    if (node?.type === "element" && node?.tagName === "figure") {
      if (!("data-rehype-pretty-code-figure" in node.properties)) {
        return;
      }

      for (const child of node.children) {
        if (child.tagName === "pre") {
          child.properties["raw"] = node.properties.raw;
          node.properties.raw = undefined;
          // console.log("ğŸš¨ postProcess ~", child, node.properties.raw);
        }
      }
    }
  });
};


```

`contentlayer.config.js` ä¸­å¼•ç”¨è¯¥æ’ä»¶
```js
import { preProcess, postProcess } from "./lib/copy-code";

...
export default makeSource({
  ...
  mdx: {
    remarkPlugins: [
     ...
    ],
    rehypePlugins: [
      // è·å–ä»£ç å—å†…å®¹
      preProcess,
      [
        rehypePrettyCode,
        {
          theme: "github-dark",
        },
      ],
      // ä»£ç å—å†…å®¹æ”¾è¿›pre.raw
      postProcess,
      ...
    ],
  },
});
```

`Markdown.tsx` åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å¹¶ä¼ é€’å‚æ•°
```js
import { useMDXComponent } from "next-contentlayer/hooks";
import type { MDXComponents } from "mdx/types";

const components: MDXComponents = {
  ...
  pre: ({ className, ...props }) => (
    <pre
      className={cn(
        "px-0",
        "group relative m-0 overflow-x-auto rounded-md py-4",
        className
      )}
      {...props}
    >
      {/* @ts-ignore */}
      {/* è‡ªå·±ç¼–å†™çš„å¤åˆ¶æŒ‰é’®ï¼Œprops.rawä¸ºä»£ç å—å†…å®¹ */}
      <CodeCopyButton text={props.raw} />
      {props.children}
    </pre>
  ),
};

export function Mdx({ code }: { code: string }) {
  const Component = useMDXComponent(code);

  return (
    <div className="mdx">
      <Component components={components} />
    </div>
  );
}

```

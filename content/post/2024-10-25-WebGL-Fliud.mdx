---
title: WebGL 流体模拟
subtitle: 
layout: post
date: 2024-10-29
author: heavenmei
categories:
  - Post
description: 
tags:
  - WebGL
url: 
image:
---
粒子系统是模拟中的核心，采用了PIC/FLIP方法来模拟流体动力学。GPU并行处理能力的利用大大提升了模拟速度和渲染性能，而球形环境光遮挡体积技术则增强了3D模型的真实感。

## 模拟粒子

传递粒子速度到网格，我们分两步向网格传递粒子速度：

1. 我们将weight * velocity累加到tempVelocityTexture中，然后将weight累加到weightTexture中
2. velocityTexture = tempVelocityTexture / weightttexture

我们累积到velocityWeightTexture，然后划分到velocityTexture





### 球形绘制
#### ANGLE_instanced_arrays
WebGL中实例化渲染的扩展。实例化渲染允许您在单个绘制调用中多次使用相同的几何体，并对每个实例应用不同的属性（如颜色、位置、大小等）。
- `drawArraysInstancedANGLE(mode, first, count, primcount)` ： 类似`gl.drawArrays()`
- `vertexAttribDivisorANGLE(index, divisor)`：用于设置通用顶点属性的分频器（divisor）。分频器确定属性在多个实例之间的更新频率。
- `drawElementsInstancedANGLE(mode,count,type,offset,primcount)`：类似`gl.drawElements()
	- `mode`：图元类型
	- `count`：绘制索引数量
	- `type`：索引数组数据类型
	- `offset`：索引数组偏移量
	- `primcount`：绘制实例数量


```js
precision highp float;

attribute vec3 a_vertexPosition;
attribute vec3 a_vertexNormal;

attribute vec2 a_textureCoordinates;

uniform mat4 u_projectionMatrix;
uniform mat4 u_viewMatrix;

uniform sampler2D u_positionsTexture;
uniform sampler2D u_velocitiesTexture;

uniform float u_sphereRadius;

varying vec3 v_viewSpacePosition;
varying vec3 v_viewSpaceNormal;
varying float v_speed;
// * gl_FragColor = vec4(v_viewSpaceNormal.x, v_viewSpaceNormal.y, v_speed, XX);

void main() {
    vec3 spherePosition = texture2D(u_positionsTexture, a_textureCoordinates).rgb;

    vec3 position = a_vertexPosition * u_sphereRadius + spherePosition;

    v_viewSpacePosition = vec3(u_viewMatrix * vec4(position, 1.0));
    v_viewSpaceNormal = vec3(u_viewMatrix * vec4(a_vertexNormal, 0.0)); //this assumes we're not doing any weird stuff in the view matrix

    gl_Position = u_projectionMatrix * vec4(v_viewSpacePosition, 1.0);

    vec3 velocity = texture2D(u_velocitiesTexture, a_textureCoordinates).rgb;
    // 根据粒子的速度大小来调整其颜色、透明度或其他属性
    v_speed = length(velocity);
}

```
### code




### 球形环境光遮挡体积技术

###  Reference
[# fluid:流体颗粒-http - 实时3D流体模拟与WebGL渲染](https://blog.csdn.net/weixin_42594427/article/details/142328230)
[WebGL入门-WebGL常用API说明详解_webgl api-CSDN博客](https://blog.csdn.net/qw8704149/article/details/115152067)
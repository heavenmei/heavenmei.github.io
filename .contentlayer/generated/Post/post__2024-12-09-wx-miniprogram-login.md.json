{
  "title": "å¾®ä¿¡å°ç¨‹åºç™»å½•æµç¨‹",
  "tags": [
    "Web"
  ],
  "author": "heavenmei",
  "subtitle": null,
  "description": null,
  "date": "2024-12-09T00:00:00.000Z",
  "body": {
    "raw": "\nä¸€ä¸ªç®€å•çš„ç”¨æˆ·ç³»ç»Ÿéœ€è¦å…³æ³¨è‡³å°‘è¿™äº›å±‚é¢\n\n- å®‰å…¨æ€§(åŠ å¯†)\n- æŒä¹…åŒ–ç™»å½•æ€(ç±»ä¼¼cookie)\n- ç™»å½•è¿‡æœŸå¤„ç†\n- ç¡®ä¿ç”¨æˆ·å”¯ä¸€æ€§, é¿å…å‡ºçŽ°å¤šè´¦å·\n- æŽˆæƒ\n- ç»‘å®šç”¨æˆ·æ˜µç§°å¤´åƒç­‰ä¿¡æ¯\n- ç»‘å®šæ‰‹æœºå·(å®žåå’Œå¯†ä¿æ–¹å¼)\n\n\n## ç™»å½•æµç¨‹\n- é€šè¿‡wx.login()èŽ·å–codeã€‚\n- å°†è¿™ä¸ªcodeå‘é€ç»™åŽç«¯ï¼ŒåŽç«¯ä¼šè¿”å›žä¸€ä¸ªtokenï¼Œè¿™ä¸ªtokenå°†ä½œä¸ºä½ èº«ä»½çš„å”¯ä¸€æ ‡è¯†ã€‚\n- å°†tokené€šè¿‡wx.setStorageSync()ä¿å­˜åœ¨æœ¬åœ°å­˜å‚¨ã€‚\n- ç”¨æˆ·ä¸‹æ¬¡è¿›å…¥â»šé¢æ—¶ï¼Œä¼šå…ˆé€šè¿‡wx.getStorageSync() æ–¹æ³•åˆ¤æ–­tokenæ˜¯å¦æœ‰å€¼ï¼Œå¦‚æžœæœ‰å€¼ï¼Œåˆ™å¯ä»¥è¯·æ±‚å…¶å®ƒæ•°æ®ï¼Œå¦‚æžœæ²¡æœ‰å€¼ï¼Œåˆ™è¿›è¡Œç™»å½•æ“ä½œã€‚\n\n\n![](assets/2024-12-09-wechat-login-20241209112239.png)\n\n- `appId`Â å°ç¨‹åºå”¯ä¸€æ ‡è¯†\n- `appSecret`Â å°ç¨‹åºçš„ app secret, å¯ä»¥å’Œ code, appId ä¸€èµ·æ¢å– session_key\n\n\n\n**æ³¨æ„âš ï¸**\n1. ä¼šè¯å¯†é’¥Â `session_key`Â æ˜¯å¯¹ç”¨æˆ·æ•°æ®è¿›è¡ŒÂ [åŠ å¯†ç­¾å](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html)Â çš„å¯†é’¥ã€‚ä¸ºäº†åº”ç”¨è‡ªèº«çš„æ•°æ®å®‰å…¨ï¼Œå¼€å‘è€…æœåŠ¡å™¨**ä¸åº”è¯¥æŠŠä¼šè¯å¯†é’¥ä¸‹å‘åˆ°å°ç¨‹åºï¼Œä¹Ÿä¸åº”è¯¥å¯¹å¤–æä¾›è¿™ä¸ªå¯†é’¥**ã€‚\n2. ä¸´æ—¶ç™»å½•å‡­è¯ code åªèƒ½ä½¿ç”¨ä¸€æ¬¡\n\n\n## OAuth\n>  åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ï¼Œoauth æŽˆæƒç™»å½•ä¸»è¦æ˜¯ code æ¢å– openId å’Œ sessionKey çš„è¿‡ç¨‹\n\nOAuthåœ¨\"å®¢æˆ·ç«¯\"ä¸Ž\"æœåŠ¡æä¾›å•†\"ä¹‹é—´ï¼Œè®¾ç½®äº†ä¸€ä¸ªæŽˆæƒå±‚ï¼ˆauthorization layerï¼‰ã€‚\"å®¢æˆ·ç«¯\"ä¸èƒ½ç›´æŽ¥ç™»å½•\"æœåŠ¡æä¾›å•†\"ï¼Œåªèƒ½ç™»å½•æŽˆæƒå±‚ï¼Œä»¥æ­¤å°†ç”¨æˆ·ä¸Žå®¢æˆ·ç«¯åŒºåˆ†å¼€æ¥ã€‚\"å®¢æˆ·ç«¯\"ç™»å½•æŽˆæƒå±‚æ‰€ç”¨çš„ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä¸Žç”¨æˆ·çš„å¯†ç ä¸åŒã€‚ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•çš„æ—¶å€™ï¼ŒæŒ‡å®šæŽˆæƒå±‚ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚\n\"å®¢æˆ·ç«¯\"ç™»å½•æŽˆæƒå±‚ä»¥åŽï¼Œ\"æœåŠ¡æä¾›å•†\"æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸï¼Œå‘\"å®¢æˆ·ç«¯\"å¼€æ”¾ç”¨æˆ·å‚¨å­˜çš„èµ„æ–™ã€‚\n\n\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœåŠ¡ç«¯é‡‡ç”¨[Lucia](https://lucia-auth.com/)å®žçŽ°, Lucia æ˜¯æœåŠ¡å™¨çš„ä¸€ä¸ªå¼€æºèº«ä»½éªŒè¯åº“ï¼Œå®ƒæ¶ˆé™¤äº†å¤„ç†ä¼šè¯çš„å¤æ‚æ€§ã€‚å®ƒä¸Žæ‚¨çš„æ•°æ®åº“ä¸€èµ·å·¥ä½œï¼Œæä¾›æ˜“äºŽä½¿ç”¨ã€ç†è§£å’Œæ‰©å±•çš„ APIã€‚*ä½†æ˜¯è‡ª2025å¹´3æœˆå¼€å§‹ä¸å†ç»´æŠ¤*ã€‚\n\n\n\né¦–å…ˆåœ¨è¿å‰ç«¯å°ç¨‹åºä¸­ï¼Œ`wx.login()`èŽ·å–ä¸´æ—¶codeï¼Œç„¶åŽä¼ å›žç»™å¼€å‘æœåŠ¡å™¨\n\n>2021å¹´4æœˆèµ·å°ç¨‹åºä¸å†æ”¯æŒ`wx.getUserInfo`èŽ·å–ï¼Œéœ€è¦ç”¨`wx.getUserProfile`æ›¿æ¢ã€‚è€Œä¸”å¿…é¡»æ˜¯ç”¨æˆ·ç‚¹å‡»åŽè°ƒç”¨ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼ˆè§„çŸ©çœŸå¤šðŸ’¢ï¼‰\n>`Error: MiniProgramError {\"errMsg\":\"getUserProfile:fail can only be invoked by user TAP gesture.\"}`\n\n\n```js\nexport const loginProfile = async (app) => {\n  // promisifyæ˜¯å°è£…çš„wx å¼‚æ­¥å‡½æ•°\n  const res = await promisify(wx.getUserProfile)({\n    desc: \"ç”¨äºŽå®Œå–„ä¼šå‘˜èµ„æ–™\",\n  });\n  const { code } = await promisify(wx.login)();\n\n  // loginæ˜¯ä¼ å›žè‡ªå·±æœåŠ¡çš„loginæŽ¥å£ï¼Œè¿”å›žè‡ªå®šä¹‰ç™»å½•æ€data\n  const { data } = await login({\n    code,\n    ...res.userInfo,\n  });\n  // ç¼“å­˜ç™»å½•æ€\n  wx.setStorageSync(\"userInfo\", data);\n\n  const userId = data.id;\n  startDuration(app, userId);\n  return data;\n};\n```\n\n\nåœ¨æœåŠ¡å™¨ä¸­å®žçŽ°`/login`æŽ¥å£\n```js\n\n// POST\nexport async function login(c: Context) {\n  const body = await c.req.json();\n  const { code } = UserParamsSchema.parse(body);\n\n  const { data } = await axios.get(\n    \"https://api.weixin.qq.com/sns/jscode2session\",\n    {\n      params: {\n        appid: serverEnvs.WX_APPID,\n        secret: serverEnvs.WX_SECRET,\n        js_code: code,\n        grant_type: \"authorization_code\",\n      },\n    }\n  );\n  logger.info(\"user\", data);\n\n  let curUser = null;\n  try {\n    const existingUser = await db\n      .select()\n      .from(users)\n      .where(eq(users.id, data.openid))\n      .limit(1);\n\n    if (existingUser.length === 0) {\n      curUser = {\n        id: data.openid,\n        session_key: data.session_key,\n        name: nickName,\n        avatar: avatarUrl,\n      };\n      await db.insert(users).values(curUser);\n    } else {\n      curUser = existingUser[0];\n    }\n  } catch (e: any) {\n    return c.json(\n      failRes({\n        message: e.detail,\n      })\n    );\n  }\n\n  const session = await lucia.createSession(data.openid, {});\n  const sessionCookie = lucia.createSessionCookie(session.id);\n\n  setCookie(c, lucia.sessionCookieName, sessionCookie.value);\n\n  return c.json(successRes({ ...curUser }));\n}\n```\n\n\n##  openid, unionid , code, session_key\n\n**openid**\nopenidæ˜¯ç”¨æ¥å”¯ä¸€æ ‡è¯†ç”¨æˆ·çš„ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ï¼Œæ¯ä¸ªç”¨æˆ·çš„openidéƒ½æ˜¯å”¯ä¸€çš„ã€‚é€šè¿‡openidï¼Œå°ç¨‹åºå¯ä»¥èŽ·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚å¤´åƒã€æ˜µç§°ç­‰ã€‚\n\n > æ³¨æ„ï¼šÂ åŒä¸€ä¸ªç”¨æˆ·åœ¨ä¸åŒçš„å°ç¨‹åºä¸­æ‹¥æœ‰ä¸åŒçš„openidã€‚å› æ­¤ï¼Œåœ¨å¼€å‘å°ç¨‹åºæ—¶ï¼Œä¸èƒ½ä½¿ç”¨openidæ¥è¿›è¡Œç”¨æˆ·çš„å”¯ä¸€æ€§åˆ¤æ–­\n\n\n**unionid**\nunionidæ˜¯åœ¨ç”¨æˆ·ç»‘å®šåŒä¸€å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·ä¸‹çš„å¤šä¸ªåº”ç”¨æ—¶ï¼Œç”¨æ¥å”¯ä¸€æ ‡è¯†ç”¨æˆ·çš„ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å¦‚æžœç”¨æˆ·åœ¨å¤šä¸ªå°ç¨‹åºä¸­ä½¿ç”¨åŒä¸€ä¸ªå¾®ä¿¡å·è¿›è¡Œç™»å½•æŽˆæƒï¼Œé‚£ä¹ˆè¿™äº›å°ç¨‹åºä¸­çš„unionidéƒ½æ˜¯ç›¸åŒçš„ã€‚\n\n> æ³¨æ„ï¼šÂ ç”¨æˆ·çš„unionidåªæœ‰åœ¨ç”¨æˆ·å°†å¤šä¸ªåº”ç”¨ç»‘å®šåˆ°åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·ä¸‹æ—¶æ‰ä¼šç”Ÿæˆã€‚å› æ­¤ï¼Œå¦‚æžœç”¨æˆ·æ²¡æœ‰ç»‘å®šå¤šä¸ªåº”ç”¨ï¼Œé‚£ä¹ˆå°ç¨‹åºå°†æ— æ³•èŽ·å–ç”¨æˆ·çš„unionidã€‚\n\n\n**code**\ncodeæ˜¯ç”¨æˆ·ç™»å½•å‡­è¯ï¼Œç”±å¾®ä¿¡æœåŠ¡å™¨é¢å‘ç»™å°ç¨‹åºã€‚åœ¨ç”¨æˆ·æŽˆæƒç™»å½•åŽï¼Œå°ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨å¾®ä¿¡ç™»å½•æŽ¥å£èŽ·å–ç”¨æˆ·çš„codeã€‚ç„¶åŽï¼Œé€šè¿‡codeå‘å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚ç”¨æˆ·çš„openidå’Œsession_keyç­‰ä¿¡æ¯ã€‚\n> **æ³¨æ„ï¼š**Â **æ¯ä¸ªcodeåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œä¸”æœ‰æ•ˆæœŸä¸º5åˆ†é’Ÿã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨codeè¿›è¡Œç™»å½•æ—¶ï¼Œéœ€è¦åŠæ—¶å°†å…¶è½¬æ¢æˆç”¨æˆ·çš„openidå’Œsession_keyç­‰ä¿¡æ¯ï¼Œä»¥å…å‡ºçŽ°codeè¿‡æœŸçš„æƒ…å†µ**\n\n\n**session_key**\nä¼šè¯å¯†é’¥, æœåŠ¡ç«¯é€šè¿‡Â [code2Session](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/code2Session.html)Â èŽ·å–\nsession_keyæœ‰ç‚¹ç±»ä¼¼äºŽæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­ä¿å­˜ç”¨æˆ·å¯†ç æ—¶æ‰€ä½¿ç”¨çš„â€œç›ï¼ˆsaltï¼‰â€ã€‚åœ¨æ•°æ®åº“ä¿å­˜ç”¨æˆ·å¯†ç æ—¶ï¼Œå¹¶ä¸æ˜¯ç›´æŽ¥å°†ç”¨æˆ·çš„å¯†ç ä»¥æ˜Žæ–‡çš„æ–¹å¼å­˜æ”¾åœ¨æ•°æ®åº“è¡¨ä¸­ï¼Œé€šå¸¸éƒ½ä¼šä½¿ç”¨SHA-1æˆ–è€…MD5ç®—æ³•å°†ç”¨æˆ·å¯†ç å’Œsaltéšæœºå­—ç¬¦ä¸²æ‹¼æŽ¥åœ¨ä¸€èµ·ï¼Œé‡æ–°è®¡ç®—ä¸€ä¸‹å†å­˜å…¥æ•°æ®åº“ä¸­ã€‚è¢«é‡æ–°ä½¿ç”¨SHA-1æˆ–MD5ç®—æ³•è®¡ç®—çš„ç”¨æˆ·å¯†ç è°éƒ½ä¸çŸ¥é“æ˜¯ä»€ä¹ˆï¼Œå¼€å‘è€…ä¹Ÿåªèƒ½æ¯”å¯¹æ¯æ¬¡ç™»å½•æ—¶è¾“å…¥çš„å¯†ç å’Œæ•°æ®åº“ä¿å­˜çš„å¯†ç æ˜¯å¦ä¸€è‡´ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·ï¼Œå´æ— æ³•çŸ¥é“å¯†ç åˆ°åº•æ˜¯ä»€ä¹ˆã€‚\n\n> å› ä¸ºsession_key å­˜åœ¨æ—¶æ•ˆæ€§é—®é¢˜ï¼ˆæ¯•ç«Ÿæ˜¯ç”¨æ¥æŸ¥çœ‹æ•æ„Ÿä¿¡æ¯ï¼‰ï¼Œè€Œå°ç¨‹åºå‰ç«¯å¯ä»¥é€šè¿‡wx.checkSession() æ¥æ£€æŸ¥session_key æ˜¯å¦è¿‡æœŸã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥ä½œä¸ºä¿å­˜ç”¨æˆ·ç™»å½•æ€çš„æœºåˆ¶ï¼Œè¿™ä¹Ÿæ˜¯å°ç¨‹åºæ–‡æ¡£ä¸­æŽ¨èçš„æ–¹æ³•ï¼š\n\n\n\n\n## è‡ªå®šä¹‰ç™»å½•æ€æŒä¹…åŒ–\n\næµè§ˆå™¨æœ‰ cookie, ç„¶è€Œå°ç¨‹åºæ²¡æœ‰ cookie, å› æ­¤ï¼Œä½¿ç”¨å°ç¨‹åºè‡ªå·±çš„**æŒä¹…åŒ–**æŽ¥å£, ä¹Ÿå°±æ˜¯ setStorage å’Œ getStorageï¼Œç»™http response headers**ç§ä¸Š cookie**ã€‚\nè¿™é‡Œä½¿ç”¨[@chunpu/http](https://github.com/chunpu/http)Â å®žçŽ°ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå°ç¨‹åºè®¾è®¡çš„ http è¯·æ±‚åº“, å¯ä»¥åœ¨å°ç¨‹åºä¸Šåƒ axios ä¸€æ ·å‘è¯·æ±‚, æ”¯æŒæ‹¦æˆªå™¨ç­‰å¼ºå¤§åŠŸèƒ½, ç”šè‡³æ¯” axios æ›´é¡ºæ‰‹\n\nåœ¨loginæŽ¥å£Â response æ‹¦æˆªå™¨\n\n```js\nhttp.interceptors.response.use((response) => {\n  // ç§ cookie\n  var { headers } = response;\n  var cookies = headers[\"set-cookie\"] || \"\";\n\n  cookies = cookies.split(/, */).reduce((prev, item) => {\n    item = item.split(/; */)[0];\n    var obj = http.qs.parse(item);\n    return Object.assign(prev, obj);\n  }, {});\n  if (cookies) {\n    return promisify(wx.getStorage)({\n      key: \"cookie\",\n    })\n      .catch(() => {})\n      .then((res) => {\n        res = res || {};\n\n        var allCookies = res.data || {};\n        Object.assign(allCookies, cookies);\n        return promisify(wx.setStorage)({\n          key: \"cookie\",\n          data: allCookies,\n        });\n      })\n      .then(() => {\n        return response;\n      });\n  }\n  return response;\n});\n```\n\n\nå½“ç„¶æˆ‘ä»¬è¿˜éœ€è¦åœ¨å‘è¯·æ±‚çš„æ—¶å€™**å¸¦ä¸Šæ‰€æœ‰ cookie**, æ­¤å¤„ç”¨çš„æ˜¯ request æ‹¦æˆªå™¨\n```js\nhttp.interceptors.request.use((config) => {\n  // ç»™è¯·æ±‚å¸¦ä¸Š cookie\n  return promisify(wx.getStorage)({\n    key: \"cookie\",\n  })\n    .catch(() => {})\n    .then((res) => {\n      if (res && res.data) {\n        Object.assign(config.headers, {\n          Cookie: http.qs.stringify(res.data, \";\", \"=\"),\n        });\n      }\n      return config;\n    });\n});\n\n```\n\n\nç™»å½•æ€ cookie æ˜¯æœ‰å¤±æ•ˆæ—¶é—´çš„, æ¯”å¦‚ä¸€å¤©, ä¸ƒå¤©, æˆ–è€…ä¸€ä¸ªæœˆã€‚ å°ç¨‹åºå·²ç»å¸®æˆ‘ä»¬å®žçŽ°å¥½äº† session æœ‰æ•ˆæœŸçš„åˆ¤æ–­Â `wx.checkSession`\n>é€šè¿‡ wx.login æŽ¥å£èŽ·å¾—çš„ç”¨æˆ·ç™»å½•æ€æ‹¥æœ‰ä¸€å®šçš„æ—¶æ•ˆæ€§ã€‚ç”¨æˆ·è¶Šä¹…æœªä½¿ç”¨å°ç¨‹åºï¼Œç”¨æˆ·ç™»å½•æ€è¶Šæœ‰å¯èƒ½å¤±æ•ˆã€‚åä¹‹å¦‚æžœç”¨æˆ·ä¸€ç›´åœ¨ä½¿ç”¨å°ç¨‹åºï¼Œåˆ™ç”¨æˆ·ç™»å½•æ€ä¸€ç›´ä¿æŒæœ‰æ•ˆ\n\n`app.js`\n\n```js\n\n\n\n```\n\n\n\n\n## Reference\n[å½»åº•æžæ‡‚å°ç¨‹åºç™»å½•æµç¨‹-é™„å°ç¨‹åºå’ŒæœåŠ¡ç«¯](https://github.com/75team/w3c/blob/master/articles/20181001_chunpu_%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B-%E9%99%84%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81.md)",
    "code": "var Component=(()=>{var h=Object.create;var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var y=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var u=(l,n)=>()=>(n||l((n={exports:{}}).exports,n),n.exports),g=(l,n)=>{for(var r in n)c(l,r,{get:n[r],enumerable:!0})},a=(l,n,r,o)=>{if(n&&typeof n==\"object\"||typeof n==\"function\")for(let s of E(n))!F.call(l,s)&&s!==r&&c(l,s,{get:()=>n[s],enumerable:!(o=p(n,s))||o.enumerable});return l};var k=(l,n,r)=>(r=l!=null?h(y(l)):{},a(n||!l||!l.__esModule?c(r,\"default\",{value:l,enumerable:!0}):r,l)),B=l=>a(c({},\"__esModule\",{value:!0}),l);var d=u((x,i)=>{i.exports=_jsx_runtime});var b={};g(b,{default:()=>f,frontmatter:()=>m});var e=k(d()),m={title:\"\\u5FAE\\u4FE1\\u5C0F\\u7A0B\\u5E8F\\u767B\\u5F55\\u6D41\\u7A0B\",subtitle:null,layout:\"post\",date:new Date(17337024e5),author:\"heavenmei\",categories:[\"Post\"],description:null,tags:[\"Web\"],image:null};function t(l){let n=Object.assign({p:\"p\",ul:\"ul\",li:\"li\",h2:\"h2\",a:\"a\",span:\"span\",img:\"img\",code:\"code\",strong:\"strong\",ol:\"ol\",blockquote:\"blockquote\",em:\"em\",div:\"div\",figure:\"figure\",pre:\"pre\"},l.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"\\u4E00\\u4E2A\\u7B80\\u5355\\u7684\\u7528\\u6237\\u7CFB\\u7EDF\\u9700\\u8981\\u5173\\u6CE8\\u81F3\\u5C11\\u8FD9\\u4E9B\\u5C42\\u9762\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"\\u5B89\\u5168\\u6027(\\u52A0\\u5BC6)\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u6301\\u4E45\\u5316\\u767B\\u5F55\\u6001(\\u7C7B\\u4F3Ccookie)\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u767B\\u5F55\\u8FC7\\u671F\\u5904\\u7406\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u786E\\u4FDD\\u7528\\u6237\\u552F\\u4E00\\u6027, \\u907F\\u514D\\u51FA\\u73B0\\u591A\\u8D26\\u53F7\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u6388\\u6743\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u7ED1\\u5B9A\\u7528\\u6237\\u6635\\u79F0\\u5934\\u50CF\\u7B49\\u4FE1\\u606F\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u7ED1\\u5B9A\\u624B\\u673A\\u53F7(\\u5B9E\\u540D\\u548C\\u5BC6\\u4FDD\\u65B9\\u5F0F)\"}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"\\u767B\\u5F55\\u6D41\\u7A0B\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#\\u767B\\u5F55\\u6D41\\u7A0B\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u767B\\u5F55\\u6D41\\u7A0B\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"\\u901A\\u8FC7wx.login()\\u83B7\\u53D6code\\u3002\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u5C06\\u8FD9\\u4E2Acode\\u53D1\\u9001\\u7ED9\\u540E\\u7AEF\\uFF0C\\u540E\\u7AEF\\u4F1A\\u8FD4\\u56DE\\u4E00\\u4E2Atoken\\uFF0C\\u8FD9\\u4E2Atoken\\u5C06\\u4F5C\\u4E3A\\u4F60\\u8EAB\\u4EFD\\u7684\\u552F\\u4E00\\u6807\\u8BC6\\u3002\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u5C06token\\u901A\\u8FC7wx.setStorageSync()\\u4FDD\\u5B58\\u5728\\u672C\\u5730\\u5B58\\u50A8\\u3002\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u7528\\u6237\\u4E0B\\u6B21\\u8FDB\\u5165\\u2EDA\\u9762\\u65F6\\uFF0C\\u4F1A\\u5148\\u901A\\u8FC7wx.getStorageSync() \\u65B9\\u6CD5\\u5224\\u65ADtoken\\u662F\\u5426\\u6709\\u503C\\uFF0C\\u5982\\u679C\\u6709\\u503C\\uFF0C\\u5219\\u53EF\\u4EE5\\u8BF7\\u6C42\\u5176\\u5B83\\u6570\\u636E\\uFF0C\\u5982\\u679C\\u6CA1\\u6709\\u503C\\uFF0C\\u5219\\u8FDB\\u884C\\u767B\\u5F55\\u64CD\\u4F5C\\u3002\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/post/assets/2024-12-09-wechat-login-20241209112239.png\",alt:\"\",width:\"710\",height:\"720\",blurDataURL:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAACVBMVEX9/f3u7u719fUfBACYAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAJ0lEQVR4nEWLCQoAAAjCNv//6KiIBEU8UJTI0DCInmm9GH+wldl7AQXxACrWGpnRAAAAAElFTkSuQmCC\"})}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"appId\"}),\"\\xA0\\u5C0F\\u7A0B\\u5E8F\\u552F\\u4E00\\u6807\\u8BC6\"]}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"appSecret\"}),\"\\xA0\\u5C0F\\u7A0B\\u5E8F\\u7684 app secret, \\u53EF\\u4EE5\\u548C code, appId \\u4E00\\u8D77\\u6362\\u53D6 session_key\"]}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.strong,{children:\"\\u6CE8\\u610F\\u26A0\\uFE0F\"})}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"\\u4F1A\\u8BDD\\u5BC6\\u94A5\\xA0\",(0,e.jsx)(n.code,{children:\"session_key\"}),\"\\xA0\\u662F\\u5BF9\\u7528\\u6237\\u6570\\u636E\\u8FDB\\u884C\\xA0\",(0,e.jsx)(n.a,{href:\"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html\",children:\"\\u52A0\\u5BC6\\u7B7E\\u540D\"}),\"\\xA0\\u7684\\u5BC6\\u94A5\\u3002\\u4E3A\\u4E86\\u5E94\\u7528\\u81EA\\u8EAB\\u7684\\u6570\\u636E\\u5B89\\u5168\\uFF0C\\u5F00\\u53D1\\u8005\\u670D\\u52A1\\u5668\",(0,e.jsx)(n.strong,{children:\"\\u4E0D\\u5E94\\u8BE5\\u628A\\u4F1A\\u8BDD\\u5BC6\\u94A5\\u4E0B\\u53D1\\u5230\\u5C0F\\u7A0B\\u5E8F\\uFF0C\\u4E5F\\u4E0D\\u5E94\\u8BE5\\u5BF9\\u5916\\u63D0\\u4F9B\\u8FD9\\u4E2A\\u5BC6\\u94A5\"}),\"\\u3002\"]}),`\n`,(0,e.jsx)(n.li,{children:\"\\u4E34\\u65F6\\u767B\\u5F55\\u51ED\\u8BC1 code \\u53EA\\u80FD\\u4F7F\\u7528\\u4E00\\u6B21\"}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"oauth\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#oauth\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"OAuth\"]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u5728\\u5FAE\\u4FE1\\u5C0F\\u7A0B\\u5E8F\\u4E2D\\uFF0Coauth \\u6388\\u6743\\u767B\\u5F55\\u4E3B\\u8981\\u662F code \\u6362\\u53D6 openId \\u548C sessionKey \\u7684\\u8FC7\\u7A0B\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:`OAuth\\u5728\"\\u5BA2\\u6237\\u7AEF\"\\u4E0E\"\\u670D\\u52A1\\u63D0\\u4F9B\\u5546\"\\u4E4B\\u95F4\\uFF0C\\u8BBE\\u7F6E\\u4E86\\u4E00\\u4E2A\\u6388\\u6743\\u5C42\\uFF08authorization layer\\uFF09\\u3002\"\\u5BA2\\u6237\\u7AEF\"\\u4E0D\\u80FD\\u76F4\\u63A5\\u767B\\u5F55\"\\u670D\\u52A1\\u63D0\\u4F9B\\u5546\"\\uFF0C\\u53EA\\u80FD\\u767B\\u5F55\\u6388\\u6743\\u5C42\\uFF0C\\u4EE5\\u6B64\\u5C06\\u7528\\u6237\\u4E0E\\u5BA2\\u6237\\u7AEF\\u533A\\u5206\\u5F00\\u6765\\u3002\"\\u5BA2\\u6237\\u7AEF\"\\u767B\\u5F55\\u6388\\u6743\\u5C42\\u6240\\u7528\\u7684\\u4EE4\\u724C\\uFF08token\\uFF09\\uFF0C\\u4E0E\\u7528\\u6237\\u7684\\u5BC6\\u7801\\u4E0D\\u540C\\u3002\\u7528\\u6237\\u53EF\\u4EE5\\u5728\\u767B\\u5F55\\u7684\\u65F6\\u5019\\uFF0C\\u6307\\u5B9A\\u6388\\u6743\\u5C42\\u4EE4\\u724C\\u7684\\u6743\\u9650\\u8303\\u56F4\\u548C\\u6709\\u6548\\u671F\\u3002\n\"\\u5BA2\\u6237\\u7AEF\"\\u767B\\u5F55\\u6388\\u6743\\u5C42\\u4EE5\\u540E\\uFF0C\"\\u670D\\u52A1\\u63D0\\u4F9B\\u5546\"\\u6839\\u636E\\u4EE4\\u724C\\u7684\\u6743\\u9650\\u8303\\u56F4\\u548C\\u6709\\u6548\\u671F\\uFF0C\\u5411\"\\u5BA2\\u6237\\u7AEF\"\\u5F00\\u653E\\u7528\\u6237\\u50A8\\u5B58\\u7684\\u8D44\\u6599\\u3002`}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u5728\\u8FD9\\u91CC\\uFF0C\\u6211\\u4EEC\\u670D\\u52A1\\u7AEF\\u91C7\\u7528\",(0,e.jsx)(n.a,{href:\"https://lucia-auth.com/\",children:\"Lucia\"}),\"\\u5B9E\\u73B0, Lucia \\u662F\\u670D\\u52A1\\u5668\\u7684\\u4E00\\u4E2A\\u5F00\\u6E90\\u8EAB\\u4EFD\\u9A8C\\u8BC1\\u5E93\\uFF0C\\u5B83\\u6D88\\u9664\\u4E86\\u5904\\u7406\\u4F1A\\u8BDD\\u7684\\u590D\\u6742\\u6027\\u3002\\u5B83\\u4E0E\\u60A8\\u7684\\u6570\\u636E\\u5E93\\u4E00\\u8D77\\u5DE5\\u4F5C\\uFF0C\\u63D0\\u4F9B\\u6613\\u4E8E\\u4F7F\\u7528\\u3001\\u7406\\u89E3\\u548C\\u6269\\u5C55\\u7684 API\\u3002\",(0,e.jsx)(n.em,{children:\"\\u4F46\\u662F\\u81EA2025\\u5E743\\u6708\\u5F00\\u59CB\\u4E0D\\u518D\\u7EF4\\u62A4\"}),\"\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u9996\\u5148\\u5728\\u8FC1\\u524D\\u7AEF\\u5C0F\\u7A0B\\u5E8F\\u4E2D\\uFF0C\",(0,e.jsx)(n.code,{children:\"wx.login()\"}),\"\\u83B7\\u53D6\\u4E34\\u65F6code\\uFF0C\\u7136\\u540E\\u4F20\\u56DE\\u7ED9\\u5F00\\u53D1\\u670D\\u52A1\\u5668\"]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsxs)(n.p,{children:[\"2021\\u5E744\\u6708\\u8D77\\u5C0F\\u7A0B\\u5E8F\\u4E0D\\u518D\\u652F\\u6301\",(0,e.jsx)(n.code,{children:\"wx.getUserInfo\"}),\"\\u83B7\\u53D6\\uFF0C\\u9700\\u8981\\u7528\",(0,e.jsx)(n.code,{children:\"wx.getUserProfile\"}),`\\u66FF\\u6362\\u3002\\u800C\\u4E14\\u5FC5\\u987B\\u662F\\u7528\\u6237\\u70B9\\u51FB\\u540E\\u8C03\\u7528\\uFF0C\\u4E0D\\u7136\\u4F1A\\u62A5\\u9519\\uFF08\\u89C4\\u77E9\\u771F\\u591A\\u{1F4A2}\\uFF09\n`,(0,e.jsx)(n.code,{children:'Error: MiniProgramError {\"errMsg\":\"getUserProfile:fail can only be invoked by user TAP gesture.\"}'})]}),`\n`]}),`\n`,(0,e.jsx)(n.div,{className:\"remark-code-container\",children:(0,e.jsx)(n.figure,{\"data-rehype-pretty-code-figure\":\"\",children:(0,e.jsx)(n.pre,{style:{backgroundColor:\"#24292e\",color:\"#e1e4e8\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"github-dark\",raw:`export const loginProfile = async (app) => {\n  // promisify\\u662F\\u5C01\\u88C5\\u7684wx \\u5F02\\u6B65\\u51FD\\u6570\n  const res = await promisify(wx.getUserProfile)({\n    desc: \"\\u7528\\u4E8E\\u5B8C\\u5584\\u4F1A\\u5458\\u8D44\\u6599\",\n  });\n  const { code } = await promisify(wx.login)();\n\n  // login\\u662F\\u4F20\\u56DE\\u81EA\\u5DF1\\u670D\\u52A1\\u7684login\\u63A5\\u53E3\\uFF0C\\u8FD4\\u56DE\\u81EA\\u5B9A\\u4E49\\u767B\\u5F55\\u6001data\n  const { data } = await login({\n    code,\n    ...res.userInfo,\n  });\n  // \\u7F13\\u5B58\\u767B\\u5F55\\u6001\n  wx.setStorageSync(\"userInfo\", data);\n\n  const userId = data.id;\n  startDuration(app, userId);\n  return data;\n};\n`,children:(0,e.jsxs)(n.code,{\"data-language\":\"js\",\"data-theme\":\"github-dark\",style:{display:\"grid\"},children:[(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"export\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" const\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" loginProfile\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" async\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" (\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"app\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#6A737D\"},children:\"  // promisify\\u662F\\u5C01\\u88C5\\u7684wx \\u5F02\\u6B65\\u51FD\\u6570\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" res\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" await\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" promisify\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(wx.getUserProfile)({\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    desc: \"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"\\u7528\\u4E8E\\u5B8C\\u5584\\u4F1A\\u5458\\u8D44\\u6599\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  });\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" { \"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"code\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" } \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" await\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" promisify\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(wx.login)();\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#6A737D\"},children:\"  // login\\u662F\\u4F20\\u56DE\\u81EA\\u5DF1\\u670D\\u52A1\\u7684login\\u63A5\\u53E3\\uFF0C\\u8FD4\\u56DE\\u81EA\\u5B9A\\u4E49\\u767B\\u5F55\\u6001data\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" { \"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"data\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" } \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" await\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" login\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"({\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    code,\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"    ...\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"res.userInfo,\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  });\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#6A737D\"},children:\"  // \\u7F13\\u5B58\\u767B\\u5F55\\u6001\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  wx.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"setStorageSync\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"userInfo\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\", data);\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" userId\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" data.id;\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"  startDuration\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(app, userId);\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  return\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" data;\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"};\"})})]})})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u5728\\u670D\\u52A1\\u5668\\u4E2D\\u5B9E\\u73B0\",(0,e.jsx)(n.code,{children:\"/login\"}),\"\\u63A5\\u53E3\"]}),`\n`,(0,e.jsx)(n.div,{className:\"remark-code-container\",children:(0,e.jsx)(n.figure,{\"data-rehype-pretty-code-figure\":\"\",children:(0,e.jsx)(n.pre,{style:{backgroundColor:\"#24292e\",color:\"#e1e4e8\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"github-dark\",raw:`\n// POST\nexport async function login(c: Context) {\n  const body = await c.req.json();\n  const { code } = UserParamsSchema.parse(body);\n\n  const { data } = await axios.get(\n    \"https://api.weixin.qq.com/sns/jscode2session\",\n    {\n      params: {\n        appid: serverEnvs.WX_APPID,\n        secret: serverEnvs.WX_SECRET,\n        js_code: code,\n        grant_type: \"authorization_code\",\n      },\n    }\n  );\n  logger.info(\"user\", data);\n\n  let curUser = null;\n  try {\n    const existingUser = await db\n      .select()\n      .from(users)\n      .where(eq(users.id, data.openid))\n      .limit(1);\n\n    if (existingUser.length === 0) {\n      curUser = {\n        id: data.openid,\n        session_key: data.session_key,\n        name: nickName,\n        avatar: avatarUrl,\n      };\n      await db.insert(users).values(curUser);\n    } else {\n      curUser = existingUser[0];\n    }\n  } catch (e: any) {\n    return c.json(\n      failRes({\n        message: e.detail,\n      })\n    );\n  }\n\n  const session = await lucia.createSession(data.openid, {});\n  const sessionCookie = lucia.createSessionCookie(session.id);\n\n  setCookie(c, lucia.sessionCookieName, sessionCookie.value);\n\n  return c.json(successRes({ ...curUser }));\n}\n`,children:(0,e.jsxs)(n.code,{\"data-language\":\"js\",\"data-theme\":\"github-dark\",style:{display:\"grid\"},children:[(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#6A737D\"},children:\"// POST\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"export\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" async\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" function\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" login\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"c\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\":\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" Context\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" body\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" await\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" c.req.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"json\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"();\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" { \"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"code\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" } \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" UserParamsSchema.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"parse\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(body);\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" { \"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"data\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" } \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" await\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" axios.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"get\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'    \"https://api.weixin.qq.com/sns/jscode2session\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    {\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      params: {\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        appid: serverEnvs.\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"WX_APPID\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        secret: serverEnvs.\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"WX_SECRET\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        js_code: code,\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        grant_type: \"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"authorization_code\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      },\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    }\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  );\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  logger.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"info\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"user\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\", data);\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  let\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" curUser \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" null\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\";\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  try\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"    const\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" existingUser\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" await\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" db\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"select\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"()\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"from\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(users)\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"where\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"eq\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(users.id, data.openid))\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"limit\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"1\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\");\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"    if\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" (existingUser.\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"length\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" ===\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" 0\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      curUser \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        id: data.openid,\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        session_key: data.session_key,\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        name: nickName,\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        avatar: avatarUrl,\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      };\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"      await\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" db.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"insert\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(users).\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"values\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(curUser);\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    } \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"else\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      curUser \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" existingUser[\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"0\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"];\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    }\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  } \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"catch\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" (\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"e\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\":\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" any\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"    return\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" c.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"json\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"      failRes\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"({\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        message: e.detail,\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      })\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    );\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  }\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" session\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" await\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" lucia.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"createSession\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(data.openid, {});\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  const\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\" sessionCookie\"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" lucia.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"createSessionCookie\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(session.id);\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"  setCookie\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(c, lucia.sessionCookieName, sessionCookie.value);\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  return\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" c.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"json\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"successRes\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"({ \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"...\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"curUser }));\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"}\"})})]})})})}),`\n`,(0,e.jsxs)(n.h2,{id:\"openid-unionid--code-session_key\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#openid-unionid--code-session_key\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"openid, unionid , code, session_key\"]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"openid\"}),`\nopenid\\u662F\\u7528\\u6765\\u552F\\u4E00\\u6807\\u8BC6\\u7528\\u6237\\u7684\\u4E00\\u4E2A\\u5B57\\u7B26\\u4E32\\u3002\\u5728\\u5FAE\\u4FE1\\u5C0F\\u7A0B\\u5E8F\\u4E2D\\uFF0C\\u6BCF\\u4E2A\\u7528\\u6237\\u7684openid\\u90FD\\u662F\\u552F\\u4E00\\u7684\\u3002\\u901A\\u8FC7openid\\uFF0C\\u5C0F\\u7A0B\\u5E8F\\u53EF\\u4EE5\\u83B7\\u53D6\\u7528\\u6237\\u7684\\u57FA\\u672C\\u4FE1\\u606F\\uFF0C\\u5982\\u5934\\u50CF\\u3001\\u6635\\u79F0\\u7B49\\u3002`]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u6CE8\\u610F\\uFF1A\\xA0\\u540C\\u4E00\\u4E2A\\u7528\\u6237\\u5728\\u4E0D\\u540C\\u7684\\u5C0F\\u7A0B\\u5E8F\\u4E2D\\u62E5\\u6709\\u4E0D\\u540C\\u7684openid\\u3002\\u56E0\\u6B64\\uFF0C\\u5728\\u5F00\\u53D1\\u5C0F\\u7A0B\\u5E8F\\u65F6\\uFF0C\\u4E0D\\u80FD\\u4F7F\\u7528openid\\u6765\\u8FDB\\u884C\\u7528\\u6237\\u7684\\u552F\\u4E00\\u6027\\u5224\\u65AD\"}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"unionid\"}),`\nunionid\\u662F\\u5728\\u7528\\u6237\\u7ED1\\u5B9A\\u540C\\u4E00\\u5FAE\\u4FE1\\u5F00\\u653E\\u5E73\\u53F0\\u8D26\\u53F7\\u4E0B\\u7684\\u591A\\u4E2A\\u5E94\\u7528\\u65F6\\uFF0C\\u7528\\u6765\\u552F\\u4E00\\u6807\\u8BC6\\u7528\\u6237\\u7684\\u4E00\\u4E2A\\u5B57\\u7B26\\u4E32\\u3002\\u5982\\u679C\\u7528\\u6237\\u5728\\u591A\\u4E2A\\u5C0F\\u7A0B\\u5E8F\\u4E2D\\u4F7F\\u7528\\u540C\\u4E00\\u4E2A\\u5FAE\\u4FE1\\u53F7\\u8FDB\\u884C\\u767B\\u5F55\\u6388\\u6743\\uFF0C\\u90A3\\u4E48\\u8FD9\\u4E9B\\u5C0F\\u7A0B\\u5E8F\\u4E2D\\u7684unionid\\u90FD\\u662F\\u76F8\\u540C\\u7684\\u3002`]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u6CE8\\u610F\\uFF1A\\xA0\\u7528\\u6237\\u7684unionid\\u53EA\\u6709\\u5728\\u7528\\u6237\\u5C06\\u591A\\u4E2A\\u5E94\\u7528\\u7ED1\\u5B9A\\u5230\\u540C\\u4E00\\u4E2A\\u5FAE\\u4FE1\\u5F00\\u653E\\u5E73\\u53F0\\u8D26\\u53F7\\u4E0B\\u65F6\\u624D\\u4F1A\\u751F\\u6210\\u3002\\u56E0\\u6B64\\uFF0C\\u5982\\u679C\\u7528\\u6237\\u6CA1\\u6709\\u7ED1\\u5B9A\\u591A\\u4E2A\\u5E94\\u7528\\uFF0C\\u90A3\\u4E48\\u5C0F\\u7A0B\\u5E8F\\u5C06\\u65E0\\u6CD5\\u83B7\\u53D6\\u7528\\u6237\\u7684unionid\\u3002\"}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"code\"}),`\ncode\\u662F\\u7528\\u6237\\u767B\\u5F55\\u51ED\\u8BC1\\uFF0C\\u7531\\u5FAE\\u4FE1\\u670D\\u52A1\\u5668\\u9881\\u53D1\\u7ED9\\u5C0F\\u7A0B\\u5E8F\\u3002\\u5728\\u7528\\u6237\\u6388\\u6743\\u767B\\u5F55\\u540E\\uFF0C\\u5C0F\\u7A0B\\u5E8F\\u53EF\\u4EE5\\u901A\\u8FC7\\u8C03\\u7528\\u5FAE\\u4FE1\\u767B\\u5F55\\u63A5\\u53E3\\u83B7\\u53D6\\u7528\\u6237\\u7684code\\u3002\\u7136\\u540E\\uFF0C\\u901A\\u8FC7code\\u5411\\u5FAE\\u4FE1\\u670D\\u52A1\\u5668\\u8BF7\\u6C42\\u7528\\u6237\\u7684openid\\u548Csession_key\\u7B49\\u4FE1\\u606F\\u3002`]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"\\u6CE8\\u610F\\uFF1A\"}),\"\\xA0\",(0,e.jsx)(n.strong,{children:\"\\u6BCF\\u4E2Acode\\u53EA\\u80FD\\u4F7F\\u7528\\u4E00\\u6B21\\uFF0C\\u4E14\\u6709\\u6548\\u671F\\u4E3A5\\u5206\\u949F\\u3002\\u56E0\\u6B64\\uFF0C\\u5728\\u4F7F\\u7528code\\u8FDB\\u884C\\u767B\\u5F55\\u65F6\\uFF0C\\u9700\\u8981\\u53CA\\u65F6\\u5C06\\u5176\\u8F6C\\u6362\\u6210\\u7528\\u6237\\u7684openid\\u548Csession_key\\u7B49\\u4FE1\\u606F\\uFF0C\\u4EE5\\u514D\\u51FA\\u73B0code\\u8FC7\\u671F\\u7684\\u60C5\\u51B5\"})]}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.strong,{children:\"session_key\"}),`\n\\u4F1A\\u8BDD\\u5BC6\\u94A5, \\u670D\\u52A1\\u7AEF\\u901A\\u8FC7\\xA0`,(0,e.jsx)(n.a,{href:\"https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/code2Session.html\",children:\"code2Session\"}),`\\xA0\\u83B7\\u53D6\nsession_key\\u6709\\u70B9\\u7C7B\\u4F3C\\u4E8E\\u6211\\u4EEC\\u5728\\u6570\\u636E\\u5E93\\u4E2D\\u4FDD\\u5B58\\u7528\\u6237\\u5BC6\\u7801\\u65F6\\u6240\\u4F7F\\u7528\\u7684\\u201C\\u76D0\\uFF08salt\\uFF09\\u201D\\u3002\\u5728\\u6570\\u636E\\u5E93\\u4FDD\\u5B58\\u7528\\u6237\\u5BC6\\u7801\\u65F6\\uFF0C\\u5E76\\u4E0D\\u662F\\u76F4\\u63A5\\u5C06\\u7528\\u6237\\u7684\\u5BC6\\u7801\\u4EE5\\u660E\\u6587\\u7684\\u65B9\\u5F0F\\u5B58\\u653E\\u5728\\u6570\\u636E\\u5E93\\u8868\\u4E2D\\uFF0C\\u901A\\u5E38\\u90FD\\u4F1A\\u4F7F\\u7528SHA-1\\u6216\\u8005MD5\\u7B97\\u6CD5\\u5C06\\u7528\\u6237\\u5BC6\\u7801\\u548Csalt\\u968F\\u673A\\u5B57\\u7B26\\u4E32\\u62FC\\u63A5\\u5728\\u4E00\\u8D77\\uFF0C\\u91CD\\u65B0\\u8BA1\\u7B97\\u4E00\\u4E0B\\u518D\\u5B58\\u5165\\u6570\\u636E\\u5E93\\u4E2D\\u3002\\u88AB\\u91CD\\u65B0\\u4F7F\\u7528SHA-1\\u6216MD5\\u7B97\\u6CD5\\u8BA1\\u7B97\\u7684\\u7528\\u6237\\u5BC6\\u7801\\u8C01\\u90FD\\u4E0D\\u77E5\\u9053\\u662F\\u4EC0\\u4E48\\uFF0C\\u5F00\\u53D1\\u8005\\u4E5F\\u53EA\\u80FD\\u6BD4\\u5BF9\\u6BCF\\u6B21\\u767B\\u5F55\\u65F6\\u8F93\\u5165\\u7684\\u5BC6\\u7801\\u548C\\u6570\\u636E\\u5E93\\u4FDD\\u5B58\\u7684\\u5BC6\\u7801\\u662F\\u5426\\u4E00\\u81F4\\uFF0C\\u5224\\u65AD\\u662F\\u5426\\u4E3A\\u5408\\u6CD5\\u7528\\u6237\\uFF0C\\u5374\\u65E0\\u6CD5\\u77E5\\u9053\\u5BC6\\u7801\\u5230\\u5E95\\u662F\\u4EC0\\u4E48\\u3002`]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u56E0\\u4E3Asession_key \\u5B58\\u5728\\u65F6\\u6548\\u6027\\u95EE\\u9898\\uFF08\\u6BD5\\u7ADF\\u662F\\u7528\\u6765\\u67E5\\u770B\\u654F\\u611F\\u4FE1\\u606F\\uFF09\\uFF0C\\u800C\\u5C0F\\u7A0B\\u5E8F\\u524D\\u7AEF\\u53EF\\u4EE5\\u901A\\u8FC7wx.checkSession() \\u6765\\u68C0\\u67E5session_key \\u662F\\u5426\\u8FC7\\u671F\\u3002\\u6240\\u4EE5\\u53EF\\u4EE5\\u901A\\u8FC7\\u8FD9\\u4E2A\\u6765\\u4F5C\\u4E3A\\u4FDD\\u5B58\\u7528\\u6237\\u767B\\u5F55\\u6001\\u7684\\u673A\\u5236\\uFF0C\\u8FD9\\u4E5F\\u662F\\u5C0F\\u7A0B\\u5E8F\\u6587\\u6863\\u4E2D\\u63A8\\u8350\\u7684\\u65B9\\u6CD5\\uFF1A\"}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"\\u81EA\\u5B9A\\u4E49\\u767B\\u5F55\\u6001\\u6301\\u4E45\\u5316\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#\\u81EA\\u5B9A\\u4E49\\u767B\\u5F55\\u6001\\u6301\\u4E45\\u5316\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u81EA\\u5B9A\\u4E49\\u767B\\u5F55\\u6001\\u6301\\u4E45\\u5316\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6D4F\\u89C8\\u5668\\u6709 cookie, \\u7136\\u800C\\u5C0F\\u7A0B\\u5E8F\\u6CA1\\u6709 cookie, \\u56E0\\u6B64\\uFF0C\\u4F7F\\u7528\\u5C0F\\u7A0B\\u5E8F\\u81EA\\u5DF1\\u7684\",(0,e.jsx)(n.strong,{children:\"\\u6301\\u4E45\\u5316\"}),\"\\u63A5\\u53E3, \\u4E5F\\u5C31\\u662F setStorage \\u548C getStorage\\uFF0C\\u7ED9http response headers\",(0,e.jsx)(n.strong,{children:\"\\u79CD\\u4E0A cookie\"}),`\\u3002\n\\u8FD9\\u91CC\\u4F7F\\u7528`,(0,e.jsx)(n.a,{href:\"https://github.com/chunpu/http\",children:\"@chunpu/http\"}),\"\\xA0\\u5B9E\\u73B0\\uFF0C\\u8FD9\\u662F\\u4E00\\u4E2A\\u4E13\\u95E8\\u4E3A\\u5C0F\\u7A0B\\u5E8F\\u8BBE\\u8BA1\\u7684 http \\u8BF7\\u6C42\\u5E93, \\u53EF\\u4EE5\\u5728\\u5C0F\\u7A0B\\u5E8F\\u4E0A\\u50CF axios \\u4E00\\u6837\\u53D1\\u8BF7\\u6C42, \\u652F\\u6301\\u62E6\\u622A\\u5668\\u7B49\\u5F3A\\u5927\\u529F\\u80FD, \\u751A\\u81F3\\u6BD4 axios \\u66F4\\u987A\\u624B\"]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5728login\\u63A5\\u53E3\\xA0response \\u62E6\\u622A\\u5668\"}),`\n`,(0,e.jsx)(n.div,{className:\"remark-code-container\",children:(0,e.jsx)(n.figure,{\"data-rehype-pretty-code-figure\":\"\",children:(0,e.jsx)(n.pre,{style:{backgroundColor:\"#24292e\",color:\"#e1e4e8\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"github-dark\",raw:`http.interceptors.response.use((response) => {\n  // \\u79CD cookie\n  var { headers } = response;\n  var cookies = headers[\"set-cookie\"] || \"\";\n\n  cookies = cookies.split(/, */).reduce((prev, item) => {\n    item = item.split(/; */)[0];\n    var obj = http.qs.parse(item);\n    return Object.assign(prev, obj);\n  }, {});\n  if (cookies) {\n    return promisify(wx.getStorage)({\n      key: \"cookie\",\n    })\n      .catch(() => {})\n      .then((res) => {\n        res = res || {};\n\n        var allCookies = res.data || {};\n        Object.assign(allCookies, cookies);\n        return promisify(wx.setStorage)({\n          key: \"cookie\",\n          data: allCookies,\n        });\n      })\n      .then(() => {\n        return response;\n      });\n  }\n  return response;\n});\n`,children:(0,e.jsxs)(n.code,{\"data-language\":\"js\",\"data-theme\":\"github-dark\",style:{display:\"grid\"},children:[(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"http.interceptors.response.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"use\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"((\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"response\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#6A737D\"},children:\"  // \\u79CD cookie\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  var\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" { headers } \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" response;\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  var\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" cookies \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" headers[\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"set-cookie\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"] \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"||\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:' \"\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\";\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  cookies \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" cookies.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"split\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:\"/\"}),(0,e.jsx)(n.span,{style:{color:\"#DBEDFF\"},children:\", \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"*\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:\"/\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\").\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"reduce\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"((\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"prev\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\", \"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"item\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    item \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" item.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"split\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:\"/\"}),(0,e.jsx)(n.span,{style:{color:\"#DBEDFF\"},children:\"; \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"*\"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:\"/\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\")[\"}),(0,e.jsx)(n.span,{style:{color:\"#79B8FF\"},children:\"0\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"];\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"    var\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" obj \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" http.qs.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"parse\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(item);\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"    return\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" Object.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"assign\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(prev, obj);\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  }, {});\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  if\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" (cookies) {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"    return\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" promisify\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(wx.getStorage)({\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      key: \"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"cookie\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    })\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"catch\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(() \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {})\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"then\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"((\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"res\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        res \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" res \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"||\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {};\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"        var\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" allCookies \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" res.data \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"||\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {};\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        Object.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"assign\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(allCookies, cookies);\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"        return\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" promisify\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(wx.setStorage)({\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"          key: \"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"cookie\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"          data: allCookies,\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        });\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      })\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"then\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(() \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"        return\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" response;\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      });\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  }\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  return\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" response;\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"});\"})})]})})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u5F53\\u7136\\u6211\\u4EEC\\u8FD8\\u9700\\u8981\\u5728\\u53D1\\u8BF7\\u6C42\\u7684\\u65F6\\u5019\",(0,e.jsx)(n.strong,{children:\"\\u5E26\\u4E0A\\u6240\\u6709 cookie\"}),\", \\u6B64\\u5904\\u7528\\u7684\\u662F request \\u62E6\\u622A\\u5668\"]}),`\n`,(0,e.jsx)(n.div,{className:\"remark-code-container\",children:(0,e.jsx)(n.figure,{\"data-rehype-pretty-code-figure\":\"\",children:(0,e.jsx)(n.pre,{style:{backgroundColor:\"#24292e\",color:\"#e1e4e8\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"github-dark\",raw:`http.interceptors.request.use((config) => {\n  // \\u7ED9\\u8BF7\\u6C42\\u5E26\\u4E0A cookie\n  return promisify(wx.getStorage)({\n    key: \"cookie\",\n  })\n    .catch(() => {})\n    .then((res) => {\n      if (res && res.data) {\n        Object.assign(config.headers, {\n          Cookie: http.qs.stringify(res.data, \";\", \"=\"),\n        });\n      }\n      return config;\n    });\n});\n\n`,children:(0,e.jsxs)(n.code,{\"data-language\":\"js\",\"data-theme\":\"github-dark\",style:{display:\"grid\"},children:[(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"http.interceptors.request.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"use\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"((\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"config\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#6A737D\"},children:\"  // \\u7ED9\\u8BF7\\u6C42\\u5E26\\u4E0A cookie\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"  return\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\" promisify\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(wx.getStorage)({\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    key: \"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"cookie\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\",\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"  })\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"catch\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(() \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {})\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    .\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"then\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"((\"}),(0,e.jsx)(n.span,{style:{color:\"#FFAB70\"},children:\"res\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\") \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"=>\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"      if\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" (res \"}),(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"&&\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" res.data) {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        Object.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"assign\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(config.headers, {\"})]}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"          Cookie: http.qs.\"}),(0,e.jsx)(n.span,{style:{color:\"#B392F0\"},children:\"stringify\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"(res.data, \"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\";\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\", \"}),(0,e.jsx)(n.span,{style:{color:\"#9ECBFF\"},children:'\"=\"'}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"),\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"        });\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"      }\"})}),`\n`,(0,e.jsxs)(n.span,{\"data-line\":\"\",children:[(0,e.jsx)(n.span,{style:{color:\"#F97583\"},children:\"      return\"}),(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\" config;\"})]}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"    });\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:(0,e.jsx)(n.span,{style:{color:\"#E1E4E8\"},children:\"});\"})}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"})]})})})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u767B\\u5F55\\u6001 cookie \\u662F\\u6709\\u5931\\u6548\\u65F6\\u95F4\\u7684, \\u6BD4\\u5982\\u4E00\\u5929, \\u4E03\\u5929, \\u6216\\u8005\\u4E00\\u4E2A\\u6708\\u3002 \\u5C0F\\u7A0B\\u5E8F\\u5DF2\\u7ECF\\u5E2E\\u6211\\u4EEC\\u5B9E\\u73B0\\u597D\\u4E86 session \\u6709\\u6548\\u671F\\u7684\\u5224\\u65AD\\xA0\",(0,e.jsx)(n.code,{children:\"wx.checkSession\"})]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u901A\\u8FC7 wx.login \\u63A5\\u53E3\\u83B7\\u5F97\\u7684\\u7528\\u6237\\u767B\\u5F55\\u6001\\u62E5\\u6709\\u4E00\\u5B9A\\u7684\\u65F6\\u6548\\u6027\\u3002\\u7528\\u6237\\u8D8A\\u4E45\\u672A\\u4F7F\\u7528\\u5C0F\\u7A0B\\u5E8F\\uFF0C\\u7528\\u6237\\u767B\\u5F55\\u6001\\u8D8A\\u6709\\u53EF\\u80FD\\u5931\\u6548\\u3002\\u53CD\\u4E4B\\u5982\\u679C\\u7528\\u6237\\u4E00\\u76F4\\u5728\\u4F7F\\u7528\\u5C0F\\u7A0B\\u5E8F\\uFF0C\\u5219\\u7528\\u6237\\u767B\\u5F55\\u6001\\u4E00\\u76F4\\u4FDD\\u6301\\u6709\\u6548\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.code,{children:\"app.js\"})}),`\n`,(0,e.jsx)(n.div,{className:\"remark-code-container\",children:(0,e.jsx)(n.figure,{\"data-rehype-pretty-code-figure\":\"\",children:(0,e.jsx)(n.pre,{style:{backgroundColor:\"#24292e\",color:\"#e1e4e8\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"github-dark\",raw:`\n\n\n`,children:(0,e.jsxs)(n.code,{\"data-language\":\"js\",\"data-theme\":\"github-dark\",style:{display:\"grid\"},children:[(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"}),`\n`,(0,e.jsx)(n.span,{\"data-line\":\"\",children:\" \"})]})})})}),`\n`,(0,e.jsxs)(n.h2,{id:\"reference\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#reference\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Reference\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.a,{href:\"https://github.com/75team/w3c/blob/master/articles/20181001_chunpu_%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B-%E9%99%84%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81.md\",children:\"\\u5F7B\\u5E95\\u641E\\u61C2\\u5C0F\\u7A0B\\u5E8F\\u767B\\u5F55\\u6D41\\u7A0B-\\u9644\\u5C0F\\u7A0B\\u5E8F\\u548C\\u670D\\u52A1\\u7AEF\"})})]})}function A(l={}){let{wrapper:n}=l.components||{};return n?(0,e.jsx)(n,Object.assign({},l,{children:(0,e.jsx)(t,l)})):t(l)}var f=A;return B(b);})();\n;return Component;"
  },
  "_id": "post/2024-12-09-wx-miniprogram-login.md",
  "_raw": {
    "sourceFilePath": "post/2024-12-09-wx-miniprogram-login.md",
    "sourceFileName": "2024-12-09-wx-miniprogram-login.md",
    "sourceFileDir": "post",
    "contentType": "markdown",
    "flattenedPath": "post/2024-12-09-wx-miniprogram-login"
  },
  "type": "Post",
  "parDir": "post",
  "slug": "/post/2024-12-09-wx-miniprogram-login",
  "slugAsParams": "2024-12-09-wx-miniprogram-login"
}
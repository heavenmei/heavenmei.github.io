{
  "title": "Webpack 热更新 H M R",
  "tags": [
    "Web"
  ],
  "author": "heavenmei",
  "subtitle": null,
  "description": null,
  "date": "2023-01-20T00:00:00.000Z",
  "body": {
    "raw": "\n\n![|500](assets/2023-01-20-HMR-20250329084040.png)\n### HMR流程\n\n1. 监听文件变化，重新编译打包\n    \n2. WDM监控代码变化，并且告诉 webpack，将代码打包到内存中\n    \n3. `watchContentBase` 为 true 时，WDS 会监听配置文件夹中静态文件的变化，通知浏览器端进行 live reload。\n    \n4. 建立websorket长连接，将 webpack 编译打包的各个阶段的状态信息告知浏览器端，传递新模块的 hash\n    \n5. webpack/hot/dev-server 的根据WDS/client 传给它的信息和 dev-server 的配置决定是reload还是HMR\n    \n6. HotModuleReplacement.runtime 是客户端 HMR 的中枢，它接收新模块的 hash 值\n    \n7. JsonpMainTemplate.runtime\n    \n8. JsonpMainTemplate.runtime 向 server 端发送 Ajax 请求，服务端返回一个 json，该 json 包含了所有要更新的模块的 hash 值，\n    \n9. 再次通过 jsonp 请求，获取到最新的模块代码\n    \n10. HotModulePlugin 将会对新旧模块进行对比，决定是否更新模块，在决定更新模块后，检查模块之间的依赖关系，更新模块的同时更新模块间的依赖引用。\n    \n11. 当 HMR 失败后，回退到 live reload 操作，浏览器刷新\n    \n\n### **核心流程总结：**\n\n1. 使用 `webpack-dev-server` (后面简称 WDS)托管静态资源，同时以 Runtime 方式注入 HMR 客户端代码\n    \n2. 浏览器加载页面后，与 WDS 建立 WebSocket 连接\n    \n3. Webpack 监听到文件变化后，增量构建发生变更的模块，并通过 WebSocket 发送 `hash` 事件\n    \n4. 浏览器接收到 `hash` 事件后，请求 `manifest` 资源文件，确认增量变更范围\n    \n5. 浏览器加载发生变更的增量模块\n    \n6. Webpack 运行时触发变更模块的 `module.hot.accept` 回调，执行代码变更逻辑\n    \n7. done\n    \n\n### 参考资料\n\n[Webpack 原理系列十：HMR 原理全解析](https://zhuanlan.zhihu.com/p/410510492)\n\n[Webpack HMR 原理解析](https://zhuanlan.zhihu.com/p/30669007)\n\n  \n\n## Fast Refresh",
    "code": "var Component=(()=>{var o=Object.create;var l=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var g=(i,n)=>()=>(n||i((n={exports:{}}).exports,n),n.exports),f=(i,n)=>{for(var r in n)l(i,r,{get:n[r],enumerable:!0})},a=(i,n,r,h)=>{if(n&&typeof n==\"object\"||typeof n==\"function\")for(let c of A(n))!u.call(i,c)&&c!==r&&l(i,c,{get:()=>n[c],enumerable:!(h=p(n,c))||h.enumerable});return i};var b=(i,n,r)=>(r=i!=null?o(m(i)):{},a(n||!i||!i.__esModule?l(r,\"default\",{value:i,enumerable:!0}):r,i)),M=i=>a(l({},\"__esModule\",{value:!0}),i);var t=g((R,d)=>{d.exports=_jsx_runtime});var v={};f(v,{default:()=>W,frontmatter:()=>N});var e=b(t()),N={title:\"Webpack \\u70ED\\u66F4\\u65B0 H M R\",subtitle:null,layout:\"post\",date:new Date(16741728e5),author:\"heavenmei\",categories:[\"Note\"],description:null,tags:[\"Web\"],image:null};function s(i){let n=Object.assign({p:\"p\",img:\"img\",h3:\"h3\",a:\"a\",span:\"span\",ol:\"ol\",li:\"li\",code:\"code\",strong:\"strong\",h2:\"h2\"},i.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/post/assets/2023-01-20-HMR-20250329084040.png\",alt:\"|500\",width:\"805\",height:\"837\",blurDataURL:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAkFBMVEWu9K/r7+euye3/7+W52P3s0cXo+OW198/Yxrrp4937/fvq/f/U4fDh4en9zN7/6Ozc1tr9n83/3tzq8uSmrqG74L7/8ey0+ez69OfT+vSi6aKM45bQ69He7uTb7NfM47mx+bOtwNe76fD///LW8Nn///nQ/Nr/3PX/ltrB/92w8r2t//////+f9rLW//LH8P/gDvi1AAAAJnRSTlPMoPti/iGO/UE/rv2J+5va+5t8yl+mmfx4rq6wucOJbtyW+1CwvaBs/rcAAAAJcEhZcwAACxMAAAsTAQCanBgAAABKSURBVHicBcEFAoAgAASwEykFu7u7/v87N5iLPVdlnUN/47NmVwGu1HqK28bUpEbCUxNssGQsLQZNCaHO5qJ9hTj8PUDXA4i88AfG8QT5j378hAAAAABJRU5ErkJggg==\"})}),`\n`,(0,e.jsxs)(n.h3,{id:\"hmr\\u6D41\\u7A0B\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#hmr\\u6D41\\u7A0B\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"HMR\\u6D41\\u7A0B\"]}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u76D1\\u542C\\u6587\\u4EF6\\u53D8\\u5316\\uFF0C\\u91CD\\u65B0\\u7F16\\u8BD1\\u6253\\u5305\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"WDM\\u76D1\\u63A7\\u4EE3\\u7801\\u53D8\\u5316\\uFF0C\\u5E76\\u4E14\\u544A\\u8BC9 webpack\\uFF0C\\u5C06\\u4EE3\\u7801\\u6253\\u5305\\u5230\\u5185\\u5B58\\u4E2D\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"watchContentBase\"}),\" \\u4E3A true \\u65F6\\uFF0CWDS \\u4F1A\\u76D1\\u542C\\u914D\\u7F6E\\u6587\\u4EF6\\u5939\\u4E2D\\u9759\\u6001\\u6587\\u4EF6\\u7684\\u53D8\\u5316\\uFF0C\\u901A\\u77E5\\u6D4F\\u89C8\\u5668\\u7AEF\\u8FDB\\u884C live reload\\u3002\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u5EFA\\u7ACBwebsorket\\u957F\\u8FDE\\u63A5\\uFF0C\\u5C06 webpack \\u7F16\\u8BD1\\u6253\\u5305\\u7684\\u5404\\u4E2A\\u9636\\u6BB5\\u7684\\u72B6\\u6001\\u4FE1\\u606F\\u544A\\u77E5\\u6D4F\\u89C8\\u5668\\u7AEF\\uFF0C\\u4F20\\u9012\\u65B0\\u6A21\\u5757\\u7684 hash\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"webpack/hot/dev-server \\u7684\\u6839\\u636EWDS/client \\u4F20\\u7ED9\\u5B83\\u7684\\u4FE1\\u606F\\u548C dev-server \\u7684\\u914D\\u7F6E\\u51B3\\u5B9A\\u662Freload\\u8FD8\\u662FHMR\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"HotModuleReplacement.runtime \\u662F\\u5BA2\\u6237\\u7AEF HMR \\u7684\\u4E2D\\u67A2\\uFF0C\\u5B83\\u63A5\\u6536\\u65B0\\u6A21\\u5757\\u7684 hash \\u503C\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"JsonpMainTemplate.runtime\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"JsonpMainTemplate.runtime \\u5411 server \\u7AEF\\u53D1\\u9001 Ajax \\u8BF7\\u6C42\\uFF0C\\u670D\\u52A1\\u7AEF\\u8FD4\\u56DE\\u4E00\\u4E2A json\\uFF0C\\u8BE5 json \\u5305\\u542B\\u4E86\\u6240\\u6709\\u8981\\u66F4\\u65B0\\u7684\\u6A21\\u5757\\u7684 hash \\u503C\\uFF0C\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u518D\\u6B21\\u901A\\u8FC7 jsonp \\u8BF7\\u6C42\\uFF0C\\u83B7\\u53D6\\u5230\\u6700\\u65B0\\u7684\\u6A21\\u5757\\u4EE3\\u7801\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"HotModulePlugin \\u5C06\\u4F1A\\u5BF9\\u65B0\\u65E7\\u6A21\\u5757\\u8FDB\\u884C\\u5BF9\\u6BD4\\uFF0C\\u51B3\\u5B9A\\u662F\\u5426\\u66F4\\u65B0\\u6A21\\u5757\\uFF0C\\u5728\\u51B3\\u5B9A\\u66F4\\u65B0\\u6A21\\u5757\\u540E\\uFF0C\\u68C0\\u67E5\\u6A21\\u5757\\u4E4B\\u95F4\\u7684\\u4F9D\\u8D56\\u5173\\u7CFB\\uFF0C\\u66F4\\u65B0\\u6A21\\u5757\\u7684\\u540C\\u65F6\\u66F4\\u65B0\\u6A21\\u5757\\u95F4\\u7684\\u4F9D\\u8D56\\u5F15\\u7528\\u3002\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u5F53 HMR \\u5931\\u8D25\\u540E\\uFF0C\\u56DE\\u9000\\u5230 live reload \\u64CD\\u4F5C\\uFF0C\\u6D4F\\u89C8\\u5668\\u5237\\u65B0\"}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.h3,{id:\"\\u6838\\u5FC3\\u6D41\\u7A0B\\u603B\\u7ED3\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#\\u6838\\u5FC3\\u6D41\\u7A0B\\u603B\\u7ED3\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),(0,e.jsx)(n.strong,{children:\"\\u6838\\u5FC3\\u6D41\\u7A0B\\u603B\\u7ED3\\uFF1A\"})]}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[\"\\u4F7F\\u7528 \",(0,e.jsx)(n.code,{children:\"webpack-dev-server\"}),\" (\\u540E\\u9762\\u7B80\\u79F0 WDS)\\u6258\\u7BA1\\u9759\\u6001\\u8D44\\u6E90\\uFF0C\\u540C\\u65F6\\u4EE5 Runtime \\u65B9\\u5F0F\\u6CE8\\u5165 HMR \\u5BA2\\u6237\\u7AEF\\u4EE3\\u7801\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u6D4F\\u89C8\\u5668\\u52A0\\u8F7D\\u9875\\u9762\\u540E\\uFF0C\\u4E0E WDS \\u5EFA\\u7ACB WebSocket \\u8FDE\\u63A5\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[\"Webpack \\u76D1\\u542C\\u5230\\u6587\\u4EF6\\u53D8\\u5316\\u540E\\uFF0C\\u589E\\u91CF\\u6784\\u5EFA\\u53D1\\u751F\\u53D8\\u66F4\\u7684\\u6A21\\u5757\\uFF0C\\u5E76\\u901A\\u8FC7 WebSocket \\u53D1\\u9001 \",(0,e.jsx)(n.code,{children:\"hash\"}),\" \\u4E8B\\u4EF6\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6D4F\\u89C8\\u5668\\u63A5\\u6536\\u5230 \",(0,e.jsx)(n.code,{children:\"hash\"}),\" \\u4E8B\\u4EF6\\u540E\\uFF0C\\u8BF7\\u6C42 \",(0,e.jsx)(n.code,{children:\"manifest\"}),\" \\u8D44\\u6E90\\u6587\\u4EF6\\uFF0C\\u786E\\u8BA4\\u589E\\u91CF\\u53D8\\u66F4\\u8303\\u56F4\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u6D4F\\u89C8\\u5668\\u52A0\\u8F7D\\u53D1\\u751F\\u53D8\\u66F4\\u7684\\u589E\\u91CF\\u6A21\\u5757\"}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[\"Webpack \\u8FD0\\u884C\\u65F6\\u89E6\\u53D1\\u53D8\\u66F4\\u6A21\\u5757\\u7684 \",(0,e.jsx)(n.code,{children:\"module.hot.accept\"}),\" \\u56DE\\u8C03\\uFF0C\\u6267\\u884C\\u4EE3\\u7801\\u53D8\\u66F4\\u903B\\u8F91\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsx)(n.p,{children:\"done\"}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.h3,{id:\"\\u53C2\\u8003\\u8D44\\u6599\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#\\u53C2\\u8003\\u8D44\\u6599\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u53C2\\u8003\\u8D44\\u6599\"]}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.a,{href:\"https://zhuanlan.zhihu.com/p/410510492\",children:\"Webpack \\u539F\\u7406\\u7CFB\\u5217\\u5341\\uFF1AHMR \\u539F\\u7406\\u5168\\u89E3\\u6790\"})}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.a,{href:\"https://zhuanlan.zhihu.com/p/30669007\",children:\"Webpack HMR \\u539F\\u7406\\u89E3\\u6790\"})}),`\n`,(0,e.jsxs)(n.h2,{id:\"fast-refresh\",children:[(0,e.jsx)(n.a,{className:\"header-anchor\",href:\"#fast-refresh\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"Fast Refresh\"]})]})}function k(i={}){let{wrapper:n}=i.components||{};return n?(0,e.jsx)(n,Object.assign({},i,{children:(0,e.jsx)(s,i)})):s(i)}var W=k;return M(v);})();\n;return Component;"
  },
  "_id": "post/2023-01-20-HMR.md",
  "_raw": {
    "sourceFilePath": "post/2023-01-20-HMR.md",
    "sourceFileName": "2023-01-20-HMR.md",
    "sourceFileDir": "post",
    "contentType": "markdown",
    "flattenedPath": "post/2023-01-20-HMR"
  },
  "type": "Post",
  "parDir": "post",
  "slug": "/post/2023-01-20-HMR",
  "slugAsParams": "2023-01-20-HMR"
}
{
  "title": "Webpack 热更新 HMR",
  "tags": [
    "Web"
  ],
  "author": "heavenmei",
  "subtitle": null,
  "description": null,
  "date": "2022-11-03T00:00:00.000Z",
  "body": {
    "raw": "## HMR\n`HMR`全称 `Hot Module Replacement`，可以理解为模块热替换，指在应用程序运行过程中，替换、添加、删除模块，而无需重新刷新整个应用\n\n\n```js\nconst webpack = require('webpack')\nmodule.exports = {\n  // ...\n  devServer: {\n    // 开启 HMR 特性\n    hot: true\n    // hotOnly: true\n  }\n}\n```\n\n### 核心流程总结\n\n- 通过`webpack-dev-server`（WDS）创建两个服务器：提供静态资源的服务（express）和Socket\n\t- express server 负责直接提供静态资源的服务（打包后的资源直接被浏览器请求和解析），同时以 Runtime 方式注入 HMR 客户端代码\n\t- socket server 是一个 websocket 的长连接，双方可以通信。浏览器加载页面后，与 WDS **建立 WebSocket 连接**\n- 当 socket server 监听到对应的模块发生变化时，会生成两个文件`manifest.json`和`(update) chunk.js`，\n- 通过长连接，socket server 会发送 hash 事件。\n- 浏览器接收到 `hash` 事件后，请求 `manifest` 资源文件，浏览器拿到两个新的文件后，通过HMR runtime机制，加载这两个文件，并且针对修改的模块进行更新\n\n### 详细流程\n![](assets/webpack-HMR-20250330111641.png)\n1. 监听文件变化，重新编译打包\n2. WDM监控代码变化，并且告诉 webpack，将代码打包到内存中\n3. `watchContentBase` 为 true 时，WDS 会监听配置文件夹中静态文件的变化，通知浏览器端进行 live reload。\n4. 建立websorket长连接，将 webpack 编译打包的各个阶段的状态信息告知浏览器端，传递新模块的 hash\n5. webpack/hot/dev-server 的根据WDS/client 传给它的信息和 dev-server 的配置决定是reload还是HMR\n6. HotModuleReplacement.runtime 是客户端 HMR 的中枢，它接收新模块的 hash 值\n7. JsonpMainTemplate.runtime\n8. JsonpMainTemplate.runtime 向 server 端发送 Ajax 请求，服务端返回一个 json，该 json 包含了所有要更新的模块的 hash 值，\n9. 再次通过 jsonp 请求，获取到最新的模块代码\n10. HotModulePlugin 将会对新旧模块进行对比，决定是否更新模块，在决定更新模块后，检查模块之间的依赖关系，更新模块的同时更新模块间的依赖引用。\n11. 当 HMR 失败后，回退到 live reload 操作，浏览器刷新\n## Fast Refresh\n\n\n\n\n## Reference\n\n[Webpack 原理系列十：HMR 原理全解析](https://zhuanlan.zhihu.com/p/410510492)\n\n[Webpack HMR 原理解析](https://zhuanlan.zhihu.com/p/30669007)\n",
    "code": "var Component=(()=>{var o=Object.create;var a=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var m=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var g=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),f=(r,e)=>{for(var l in e)a(r,l,{get:e[l],enumerable:!0})},s=(r,e,l,i)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let c of u(e))!A.call(r,c)&&c!==l&&a(r,c,{get:()=>e[c],enumerable:!(i=p(e,c))||i.enumerable});return r};var y=(r,e,l)=>(l=r!=null?o(m(r)):{},s(e||!r||!r.__esModule?a(l,\"default\",{value:r,enumerable:!0}):l,r)),k=r=>s(a({},\"__esModule\",{value:!0}),r);var h=g((N,t)=>{t.exports=_jsx_runtime});var M={};f(M,{default:()=>v,frontmatter:()=>E});var n=y(h()),E={title:\"Webpack \\u70ED\\u66F4\\u65B0 HMR\",subtitle:null,layout:\"post\",date:new Date(16674336e5),author:\"heavenmei\",categories:[\"Note\"],description:null,tags:[\"Web\"],image:null};function d(r){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",p:\"p\",code:\"code\",div:\"div\",figure:\"figure\",pre:\"pre\",h3:\"h3\",ul:\"ul\",li:\"li\",strong:\"strong\",img:\"img\",ol:\"ol\"},r.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h2,{id:\"hmr\",children:[(0,n.jsx)(e.a,{className:\"header-anchor\",href:\"#hmr\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"HMR\"]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.code,{children:\"HMR\"}),\"\\u5168\\u79F0\\xA0\",(0,n.jsx)(e.code,{children:\"Hot Module Replacement\"}),\"\\uFF0C\\u53EF\\u4EE5\\u7406\\u89E3\\u4E3A\\u6A21\\u5757\\u70ED\\u66FF\\u6362\\uFF0C\\u6307\\u5728\\u5E94\\u7528\\u7A0B\\u5E8F\\u8FD0\\u884C\\u8FC7\\u7A0B\\u4E2D\\uFF0C\\u66FF\\u6362\\u3001\\u6DFB\\u52A0\\u3001\\u5220\\u9664\\u6A21\\u5757\\uFF0C\\u800C\\u65E0\\u9700\\u91CD\\u65B0\\u5237\\u65B0\\u6574\\u4E2A\\u5E94\\u7528\"]}),`\n`,(0,n.jsx)(e.div,{className:\"remark-code-container\",children:(0,n.jsx)(e.figure,{\"data-rehype-pretty-code-figure\":\"\",children:(0,n.jsx)(e.pre,{style:{backgroundColor:\"#24292e\",color:\"#e1e4e8\"},tabIndex:\"0\",\"data-language\":\"js\",\"data-theme\":\"github-dark\",raw:`const webpack = require('webpack')\nmodule.exports = {\n  // ...\n  devServer: {\n    // \\u5F00\\u542F HMR \\u7279\\u6027\n    hot: true\n    // hotOnly: true\n  }\n}\n`,children:(0,n.jsxs)(e.code,{\"data-language\":\"js\",\"data-theme\":\"github-dark\",style:{display:\"grid\"},children:[(0,n.jsxs)(e.span,{\"data-line\":\"\",children:[(0,n.jsx)(e.span,{style:{color:\"#F97583\"},children:\"const\"}),(0,n.jsx)(e.span,{style:{color:\"#79B8FF\"},children:\" webpack\"}),(0,n.jsx)(e.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,n.jsx)(e.span,{style:{color:\"#B392F0\"},children:\" require\"}),(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\"(\"}),(0,n.jsx)(e.span,{style:{color:\"#9ECBFF\"},children:\"'webpack'\"}),(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\")\"})]}),`\n`,(0,n.jsxs)(e.span,{\"data-line\":\"\",children:[(0,n.jsx)(e.span,{style:{color:\"#79B8FF\"},children:\"module\"}),(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\".\"}),(0,n.jsx)(e.span,{style:{color:\"#79B8FF\"},children:\"exports\"}),(0,n.jsx)(e.span,{style:{color:\"#F97583\"},children:\" =\"}),(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\" {\"})]}),`\n`,(0,n.jsx)(e.span,{\"data-line\":\"\",children:(0,n.jsx)(e.span,{style:{color:\"#6A737D\"},children:\"  // ...\"})}),`\n`,(0,n.jsx)(e.span,{\"data-line\":\"\",children:(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\"  devServer: {\"})}),`\n`,(0,n.jsx)(e.span,{\"data-line\":\"\",children:(0,n.jsx)(e.span,{style:{color:\"#6A737D\"},children:\"    // \\u5F00\\u542F HMR \\u7279\\u6027\"})}),`\n`,(0,n.jsxs)(e.span,{\"data-line\":\"\",children:[(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\"    hot: \"}),(0,n.jsx)(e.span,{style:{color:\"#79B8FF\"},children:\"true\"})]}),`\n`,(0,n.jsx)(e.span,{\"data-line\":\"\",children:(0,n.jsx)(e.span,{style:{color:\"#6A737D\"},children:\"    // hotOnly: true\"})}),`\n`,(0,n.jsx)(e.span,{\"data-line\":\"\",children:(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\"  }\"})}),`\n`,(0,n.jsx)(e.span,{\"data-line\":\"\",children:(0,n.jsx)(e.span,{style:{color:\"#E1E4E8\"},children:\"}\"})})]})})})}),`\n`,(0,n.jsxs)(e.h3,{id:\"\\u6838\\u5FC3\\u6D41\\u7A0B\\u603B\\u7ED3\",children:[(0,n.jsx)(e.a,{className:\"header-anchor\",href:\"#\\u6838\\u5FC3\\u6D41\\u7A0B\\u603B\\u7ED3\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"\\u6838\\u5FC3\\u6D41\\u7A0B\\u603B\\u7ED3\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"\\u901A\\u8FC7\",(0,n.jsx)(e.code,{children:\"webpack-dev-server\"}),\"\\uFF08WDS\\uFF09\\u521B\\u5EFA\\u4E24\\u4E2A\\u670D\\u52A1\\u5668\\uFF1A\\u63D0\\u4F9B\\u9759\\u6001\\u8D44\\u6E90\\u7684\\u670D\\u52A1\\uFF08express\\uFF09\\u548CSocket\",`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"express server \\u8D1F\\u8D23\\u76F4\\u63A5\\u63D0\\u4F9B\\u9759\\u6001\\u8D44\\u6E90\\u7684\\u670D\\u52A1\\uFF08\\u6253\\u5305\\u540E\\u7684\\u8D44\\u6E90\\u76F4\\u63A5\\u88AB\\u6D4F\\u89C8\\u5668\\u8BF7\\u6C42\\u548C\\u89E3\\u6790\\uFF09\\uFF0C\\u540C\\u65F6\\u4EE5 Runtime \\u65B9\\u5F0F\\u6CE8\\u5165 HMR \\u5BA2\\u6237\\u7AEF\\u4EE3\\u7801\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"socket server \\u662F\\u4E00\\u4E2A websocket \\u7684\\u957F\\u8FDE\\u63A5\\uFF0C\\u53CC\\u65B9\\u53EF\\u4EE5\\u901A\\u4FE1\\u3002\\u6D4F\\u89C8\\u5668\\u52A0\\u8F7D\\u9875\\u9762\\u540E\\uFF0C\\u4E0E WDS \",(0,n.jsx)(e.strong,{children:\"\\u5EFA\\u7ACB WebSocket \\u8FDE\\u63A5\"})]}),`\n`]}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u5F53 socket server \\u76D1\\u542C\\u5230\\u5BF9\\u5E94\\u7684\\u6A21\\u5757\\u53D1\\u751F\\u53D8\\u5316\\u65F6\\uFF0C\\u4F1A\\u751F\\u6210\\u4E24\\u4E2A\\u6587\\u4EF6\",(0,n.jsx)(e.code,{children:\"manifest.json\"}),\"\\u548C\",(0,n.jsx)(e.code,{children:\"(update) chunk.js\"}),\"\\uFF0C\"]}),`\n`,(0,n.jsx)(e.li,{children:\"\\u901A\\u8FC7\\u957F\\u8FDE\\u63A5\\uFF0Csocket server \\u4F1A\\u53D1\\u9001 hash \\u4E8B\\u4EF6\\u3002\"}),`\n`,(0,n.jsxs)(e.li,{children:[\"\\u6D4F\\u89C8\\u5668\\u63A5\\u6536\\u5230 \",(0,n.jsx)(e.code,{children:\"hash\"}),\" \\u4E8B\\u4EF6\\u540E\\uFF0C\\u8BF7\\u6C42 \",(0,n.jsx)(e.code,{children:\"manifest\"}),\" \\u8D44\\u6E90\\u6587\\u4EF6\\uFF0C\\u6D4F\\u89C8\\u5668\\u62FF\\u5230\\u4E24\\u4E2A\\u65B0\\u7684\\u6587\\u4EF6\\u540E\\uFF0C\\u901A\\u8FC7HMR runtime\\u673A\\u5236\\uFF0C\\u52A0\\u8F7D\\u8FD9\\u4E24\\u4E2A\\u6587\\u4EF6\\uFF0C\\u5E76\\u4E14\\u9488\\u5BF9\\u4FEE\\u6539\\u7684\\u6A21\\u5757\\u8FDB\\u884C\\u66F4\\u65B0\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.h3,{id:\"\\u8BE6\\u7EC6\\u6D41\\u7A0B\",children:[(0,n.jsx)(e.a,{className:\"header-anchor\",href:\"#\\u8BE6\\u7EC6\\u6D41\\u7A0B\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"\\u8BE6\\u7EC6\\u6D41\\u7A0B\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/note/fontFramework/assets/webpack-HMR-20250330111641.png\",alt:\"\",width:\"805\",height:\"837\",blurDataURL:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAkFBMVEWu9K/r7+euye3/7+W52P3s0cXo+OW198/Yxrrp4937/fvq/f/U4fDh4en9zN7/6Ozc1tr9n83/3tzq8uSmrqG74L7/8ey0+ez69OfT+vSi6aKM45bQ69He7uTb7NfM47mx+bOtwNe76fD///LW8Nn///nQ/Nr/3PX/ltrB/92w8r2t//////+f9rLW//LH8P/gDvi1AAAAJnRSTlPMoPti/iGO/UE/rv2J+5va+5t8yl+mmfx4rq6wucOJbtyW+1CwvaBs/rcAAAAJcEhZcwAACxMAAAsTAQCanBgAAABKSURBVHicBcEFAoAgAASwEykFu7u7/v87N5iLPVdlnUN/47NmVwGu1HqK28bUpEbCUxNssGQsLQZNCaHO5qJ9hTj8PUDXA4i88AfG8QT5j378hAAAAABJRU5ErkJggg==\"})}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u76D1\\u542C\\u6587\\u4EF6\\u53D8\\u5316\\uFF0C\\u91CD\\u65B0\\u7F16\\u8BD1\\u6253\\u5305\"}),`\n`,(0,n.jsx)(e.li,{children:\"WDM\\u76D1\\u63A7\\u4EE3\\u7801\\u53D8\\u5316\\uFF0C\\u5E76\\u4E14\\u544A\\u8BC9 webpack\\uFF0C\\u5C06\\u4EE3\\u7801\\u6253\\u5305\\u5230\\u5185\\u5B58\\u4E2D\"}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.code,{children:\"watchContentBase\"}),\" \\u4E3A true \\u65F6\\uFF0CWDS \\u4F1A\\u76D1\\u542C\\u914D\\u7F6E\\u6587\\u4EF6\\u5939\\u4E2D\\u9759\\u6001\\u6587\\u4EF6\\u7684\\u53D8\\u5316\\uFF0C\\u901A\\u77E5\\u6D4F\\u89C8\\u5668\\u7AEF\\u8FDB\\u884C live reload\\u3002\"]}),`\n`,(0,n.jsx)(e.li,{children:\"\\u5EFA\\u7ACBwebsorket\\u957F\\u8FDE\\u63A5\\uFF0C\\u5C06 webpack \\u7F16\\u8BD1\\u6253\\u5305\\u7684\\u5404\\u4E2A\\u9636\\u6BB5\\u7684\\u72B6\\u6001\\u4FE1\\u606F\\u544A\\u77E5\\u6D4F\\u89C8\\u5668\\u7AEF\\uFF0C\\u4F20\\u9012\\u65B0\\u6A21\\u5757\\u7684 hash\"}),`\n`,(0,n.jsx)(e.li,{children:\"webpack/hot/dev-server \\u7684\\u6839\\u636EWDS/client \\u4F20\\u7ED9\\u5B83\\u7684\\u4FE1\\u606F\\u548C dev-server \\u7684\\u914D\\u7F6E\\u51B3\\u5B9A\\u662Freload\\u8FD8\\u662FHMR\"}),`\n`,(0,n.jsx)(e.li,{children:\"HotModuleReplacement.runtime \\u662F\\u5BA2\\u6237\\u7AEF HMR \\u7684\\u4E2D\\u67A2\\uFF0C\\u5B83\\u63A5\\u6536\\u65B0\\u6A21\\u5757\\u7684 hash \\u503C\"}),`\n`,(0,n.jsx)(e.li,{children:\"JsonpMainTemplate.runtime\"}),`\n`,(0,n.jsx)(e.li,{children:\"JsonpMainTemplate.runtime \\u5411 server \\u7AEF\\u53D1\\u9001 Ajax \\u8BF7\\u6C42\\uFF0C\\u670D\\u52A1\\u7AEF\\u8FD4\\u56DE\\u4E00\\u4E2A json\\uFF0C\\u8BE5 json \\u5305\\u542B\\u4E86\\u6240\\u6709\\u8981\\u66F4\\u65B0\\u7684\\u6A21\\u5757\\u7684 hash \\u503C\\uFF0C\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u518D\\u6B21\\u901A\\u8FC7 jsonp \\u8BF7\\u6C42\\uFF0C\\u83B7\\u53D6\\u5230\\u6700\\u65B0\\u7684\\u6A21\\u5757\\u4EE3\\u7801\"}),`\n`,(0,n.jsx)(e.li,{children:\"HotModulePlugin \\u5C06\\u4F1A\\u5BF9\\u65B0\\u65E7\\u6A21\\u5757\\u8FDB\\u884C\\u5BF9\\u6BD4\\uFF0C\\u51B3\\u5B9A\\u662F\\u5426\\u66F4\\u65B0\\u6A21\\u5757\\uFF0C\\u5728\\u51B3\\u5B9A\\u66F4\\u65B0\\u6A21\\u5757\\u540E\\uFF0C\\u68C0\\u67E5\\u6A21\\u5757\\u4E4B\\u95F4\\u7684\\u4F9D\\u8D56\\u5173\\u7CFB\\uFF0C\\u66F4\\u65B0\\u6A21\\u5757\\u7684\\u540C\\u65F6\\u66F4\\u65B0\\u6A21\\u5757\\u95F4\\u7684\\u4F9D\\u8D56\\u5F15\\u7528\\u3002\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u5F53 HMR \\u5931\\u8D25\\u540E\\uFF0C\\u56DE\\u9000\\u5230 live reload \\u64CD\\u4F5C\\uFF0C\\u6D4F\\u89C8\\u5668\\u5237\\u65B0\"}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"fast-refresh\",children:[(0,n.jsx)(e.a,{className:\"header-anchor\",href:\"#fast-refresh\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Fast Refresh\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"reference\",children:[(0,n.jsx)(e.a,{className:\"header-anchor\",href:\"#reference\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Reference\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:\"https://zhuanlan.zhihu.com/p/410510492\",children:\"Webpack \\u539F\\u7406\\u7CFB\\u5217\\u5341\\uFF1AHMR \\u539F\\u7406\\u5168\\u89E3\\u6790\"})}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:\"https://zhuanlan.zhihu.com/p/30669007\",children:\"Webpack HMR \\u539F\\u7406\\u89E3\\u6790\"})})]})}function b(r={}){let{wrapper:e}=r.components||{};return e?(0,n.jsx)(e,Object.assign({},r,{children:(0,n.jsx)(d,r)})):d(r)}var v=b;return k(M);})();\n;return Component;"
  },
  "_id": "note/fontFramework/webpack-HMR.md",
  "_raw": {
    "sourceFilePath": "note/fontFramework/webpack-HMR.md",
    "sourceFileName": "webpack-HMR.md",
    "sourceFileDir": "note/fontFramework",
    "contentType": "markdown",
    "flattenedPath": "note/fontFramework/webpack-HMR"
  },
  "type": "Note",
  "parDir": "note/fontFramework",
  "slug": "/post/webpack-HMR",
  "slugAsParams": "webpack-HMR"
}